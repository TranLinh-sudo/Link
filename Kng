--[[
    üíé AUTO CHEST V14 - FIX R∆†I N∆Ø·ªöC & √âP NH·∫∂T
    Ch·ª©c nƒÉng: 
    - T·∫°o s√†n ·∫£o ƒë·ª° nh√¢n v·∫≠t (Kh√¥ng bao gi·ªù r∆°i).
    - D√πng l·ªánh 'firetouchinterest' ƒë·ªÉ nh·∫∑t r∆∞∆°ng ngay l·∫≠p t·ª©c.
]]

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")

local LocalPlayer = Players.LocalPlayer
local CommF = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("CommF_")

-- // C·∫§U H√åNH //
getgenv().Config = {
    AutoChest = false,       
    AutoHop = true,
    AutoFruit = true,
    Speed = 300,
    HopDelay = 2
}

local PlatformPart = nil -- Bi·∫øn l∆∞u c√°i s√†n ·∫£o

-- // 1. GIAO DI·ªÜN ICON (NH·ªé G·ªåN) //
local ScreenGui = Instance.new("ScreenGui")
local OpenBtn = Instance.new("ImageButton")
local MainFrame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local ToggleBtn = Instance.new("TextButton")
local Status = Instance.new("TextLabel")
local UICorner = Instance.new("UICorner")

if gethui then ScreenGui.Parent = gethui() else ScreenGui.Parent = CoreGui end
ScreenGui.Name = "ChestV14_FixWater"

-- N√∫t M·ªü Menu (H√¨nh tr√≤n)
OpenBtn.Parent = ScreenGui
OpenBtn.Position = UDim2.new(0, 20, 0.4, 0)
OpenBtn.Size = UDim2.new(0, 50, 0, 50)
OpenBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
OpenBtn.Image = "rbxassetid://9267242786" -- Icon R∆∞∆°ng
OpenBtn.Active = true
OpenBtn.Draggable = true
Instance.new("UICorner", OpenBtn).CornerRadius = UDim.new(1, 0)
Instance.new("UIStroke", OpenBtn).Color = Color3.fromRGB(255, 255, 0)

-- B·∫£ng Menu
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
MainFrame.Position = UDim2.new(0.2, 0, 0.2, 0)
MainFrame.Size = UDim2.new(0, 250, 0, 180)
MainFrame.Visible = false
MainFrame.Active = true
MainFrame.Draggable = true
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)
Instance.new("UIStroke", MainFrame).Color = Color3.fromRGB(0, 255, 255)

Title.Parent = MainFrame
Title.BackgroundColor3 = Color3.fromRGB(0, 150, 200)
Title.Size = UDim2.new(1, 0, 0, 30)
Title.Text = "CHEST V14 (FIX WATER)"
Title.TextColor3 = Color3.new(1,1,1)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 16
Instance.new("UICorner", Title).CornerRadius = UDim.new(0, 10)

ToggleBtn.Parent = MainFrame
ToggleBtn.Position = UDim2.new(0.1, 0, 0.3, 0)
ToggleBtn.Size = UDim2.new(0.8, 0, 0.3, 0)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
ToggleBtn.Text = "üî¥ FARM: T·∫ÆT"
ToggleBtn.Font = Enum.Font.SourceSansBold
ToggleBtn.TextSize = 18
ToggleBtn.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(0, 8)

Status.Parent = MainFrame
Status.BackgroundTransparency = 1
Status.Position = UDim2.new(0, 10, 0.7, 0)
Status.Size = UDim2.new(1, -20, 0.2, 0)
Status.TextColor3 = Color3.new(1,1,0)
Status.Text = "S·∫µn s√†ng..."
Status.TextWrapped = true
Status.TextSize = 13

-- ƒê√≥ng/M·ªü Menu
OpenBtn.MouseButton1Click:Connect(function() MainFrame.Visible = not MainFrame.Visible end)

-- // 2. H·ªÜ TH·ªêNG "S√ÄN ·∫¢O" (FIX R∆†I N∆Ø·ªöC) //
local function CreatePlatform()
    if PlatformPart then return end
    PlatformPart = Instance.new("Part", Workspace)
    PlatformPart.Name = "AntiFallPlatform"
    PlatformPart.Size = Vector3.new(10, 1, 10)
    PlatformPart.Anchored = true
    PlatformPart.CanCollide = true
    PlatformPart.Transparency = 0.5
    PlatformPart.Color = Color3.fromRGB(0, 255, 255)
    PlatformPart.Material = Enum.Material.Neon
end

local function RemovePlatform()
    if PlatformPart then 
        PlatformPart:Destroy() 
        PlatformPart = nil
    end
end

-- C·∫≠p nh·∫≠t v·ªã tr√≠ s√†n li√™n t·ª•c d∆∞·ªõi ch√¢n nh√¢n v·∫≠t
RunService.Heartbeat:Connect(function()
    if getgenv().Config.AutoChest and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        if not PlatformPart then CreatePlatform() end
        
        local HRP = LocalPlayer.Character.HumanoidRootPart
        -- S√†n lu√¥n n·∫±m d∆∞·ªõi ch√¢n 3.5 ƒë∆°n v·ªã
        PlatformPart.CFrame = CFrame.new(HRP.Position.X, HRP.Position.Y - 3.5, HRP.Position.Z)
    else
        RemovePlatform()
    end
end)

-- // 3. H·ªÜ TH·ªêNG √âP NH·∫∂T (FIRE TOUCH) //
local function ForceTouch(target)
    if not target then return end
    -- C√°ch 1: D√πng firetouchinterest (N·∫øu Executor h·ªó tr·ª£)
    pcall(function()
        if firetouchinterest then
            firetouchinterest(LocalPlayer.Character.HumanoidRootPart, target, 0) -- Ch·∫°m
            task.wait(0.01)
            firetouchinterest(LocalPlayer.Character.HumanoidRootPart, target, 1) -- B·ªè ch·∫°m
        end
    end)
    -- C√°ch 2: D·ªãch chuy·ªÉn v·∫≠t l√Ω s√°t v√†o (D·ª± ph√≤ng)
    if LocalPlayer.Character then
        LocalPlayer.Character.HumanoidRootPart.CFrame = target.CFrame
    end
end

-- // 4. H·ªÜ TH·ªêNG BAY (TWEEN) //
local function Tween(targetCFrame)
    if not LocalPlayer.Character then return end
    local HRP = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    
    local Distance = (HRP.Position - targetCFrame.Position).Magnitude
    local Time = Distance / getgenv().Config.Speed
    local Info = TweenInfo.new(Time, Enum.EasingStyle.Linear)
    
    local T = TweenService:Create(HRP, Info, {CFrame = targetCFrame})
    T:Play()
    
    -- Noclip khi bay
    local NoclipLoop = RunService.Stepped:Connect(function()
        if LocalPlayer.Character then
            for _, v in pairs(LocalPlayer.Character:GetDescendants()) do
                if v:IsA("BasePart") then v.CanCollide = false end
            end
        end
    end)
    
    T.Completed:Wait()
    NoclipLoop:Disconnect()
end

-- // 5. H·ªÜ TH·ªêNG HOP SERVER (FIXED) //
local function HopServer()
    Status.Text = "‚è≥ ƒêang t√¨m Server m·ªõi..."
    local PlaceID = game.PlaceId
    local AllIDs = {}
    local foundAnything = ""
    local actualHour = os.date("!*t").hour
    
    local function TPReturner()
        local Site;
        if foundAnything == "" then
            Site = HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100'))
        else
            Site = HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100&cursor=' .. foundAnything))
        end
        
        if Site.nextPageCursor and Site.nextPageCursor ~= "null" and Site.nextPageCursor ~= nil then
            foundAnything = Site.nextPageCursor
        end
        
        for i,v in pairs(Site.data) do
            local Possible = true
            local ID = tostring(v.id)
            if tonumber(v.maxPlayers) > tonumber(v.playing) then
                for _,Existing in pairs(AllIDs) do
                    if num ~= 0 then
                        if ID == tostring(Existing) then Possible = false end
                    else
                        if tonumber(actualHour) ~= tonumber(Existing) then
                            local delFile = pcall(function()
                                delfile("NotSameServers.json")
                                AllIDs = {}
                                table.insert(AllIDs, actualHour)
                            end)
                        end
                    end
                    num = num + 1
                end
                if Possible == true then
                    table.insert(AllIDs, ID)
                    wait()
                    pcall(function()
                        Status.Text = "üöÄ ƒêang v√†o Server: " .. ID
                        TeleportService:TeleportToPlaceInstance(PlaceID, ID, LocalPlayer)
                    end)
                    wait(4)
                end
            end
        end
    end
    TPReturner() 
end

-- // 6. LOGIC T√åM KI·∫æM //
local function GetChest()
    local list = {}
    -- Qu√©t Workspace
    for _, v in pairs(Workspace:GetDescendants()) do
        if v.Name:find("Chest") and v:IsA("Part") and v:FindFirstChild("TouchInterest") and v.Transparency < 0.8 then
            table.insert(list, v)
        end
    end
    -- T√¨m c√°i g·∫ßn nh·∫•t
    local nearest, minDst = nil, math.huge
    local myPos = LocalPlayer.Character.HumanoidRootPart.Position
    for _, chest in pairs(list) do
        local dst = (chest.Position - myPos).Magnitude
        if dst < minDst then minDst = dst; nearest = chest end
    end
    return nearest
end

local function GetFruit()
    for _, v in pairs(Workspace:GetChildren()) do
        if string.find(v.Name, "Fruit") and v:FindFirstChild("Handle") then
            return v
        end
    end
    return nil
end

-- // 7. V√íNG L·∫∂P CH√çNH //
task.spawn(function()
    while task.wait() do
        if getgenv().Config.AutoChest then
            pcall(function()
                -- 1. ∆Øu ti√™n Fruit
                local Fruit = GetFruit()
                if Fruit and getgenv().Config.AutoFruit then
                    Status.Text = "üî• NH·∫∂T TR√ÅI: " .. Fruit.Name
                    Tween(Fruit.Handle.CFrame)
                    ForceTouch(Fruit.Handle) -- √âp nh·∫∑t
                    task.wait(0.5)
                    -- C·∫•t tr√°i
                    local args = {[1] = "StoreFruit",[2] = "Blox Fruit",[3] = Fruit}
                    CommF:InvokeServer(unpack(args))
                else
                    -- 2. Farm Chest
                    local Chest = GetChest()
                    if Chest then
                        Status.Text = "üí∞ Nh·∫∑t: " .. Chest.Name
                        
                        -- Bay t·ªõi
                        if (LocalPlayer.Character.HumanoidRootPart.Position - Chest.Position).Magnitude > 100 then
                             -- Bay cao 50m ƒë·ªÉ kh√¥ng ƒë√¢m v√†o n√∫i
                            Tween(CFrame.new(Chest.Position) * CFrame.new(0, 50, 0)) 
                        end
                        Tween(Chest.CFrame)
                        
                        -- √âP NH·∫∂T
                        ForceTouch(Chest) 
                    else
                        -- H·∫øt r∆∞∆°ng -> Hop Server
                        Status.Text = "H·∫øt r∆∞∆°ng! ƒê·ªïi Server..."
                        if getgenv().Config.AutoHop then
                            HopServer()
                            task.wait(5)
                        end
                    end
                end
            end)
        else
            RemovePlatform()
        end
    end
end)

ToggleBtn.MouseButton1Click:Connect(function()
    getgenv().Config.AutoChest = not getgenv().Config.AutoChest
    if getgenv().Config.AutoChest then
        ToggleBtn.Text = "üü¢ B·∫¨T (ON)"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
    else
        ToggleBtn.Text = "üî¥ T·∫ÆT (OFF)"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    end
end)

-- Anti-AFK
VirtualUser:CaptureController()
LocalPlayer.Idled:Connect(function() VirtualUser:ClickButton2(Vector2.new()) end)
