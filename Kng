--[[
    üíé AUTO CHEST V21 - GUARDIAN EDITION
    Ch·ª©c nƒÉng:
    - Farm R∆∞∆°ng/Tr√°i (∆Øu ti√™n Tr√°i).
    - Gi·ªØ ƒë·ªì hi·∫øm v·ªÅ Safe Zone.
    - KH√îNG ƒê·ªîI SERVER (No Hop).
    - Anti-Kick (Treo m√°y 24/7).
    - Anti-Ban (G·∫∑p Admin -> T·ª± tho√°t game ƒë·ªÉ b·∫£o to√†n acc).
]]

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local VirtualUser = game:GetService("VirtualUser")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer
local CommF = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("CommF_")

-- // C·∫§U H√åNH //
getgenv().Settings = {
    Enable = true,           
    TweenSpeed = 300,        
    MaxStoreAttempts = 5,
    StaffCheck = true,       -- B·∫≠t ch·∫ø ƒë·ªô soi Admin
    AutoRejoin = true        -- T·ª± ƒë·ªông v√†o l·∫°i n·∫øu b·ªã r·ªõt m·∫°ng
}

-- Danh s√°ch ƒë·ªì hi·∫øm
local RARE_ITEMS = {
    "God's Chalice", "Fist of Darkness", "Game Pass", 
    "Hidden Key", "Library Key", "Key" -- C√°c lo·∫°i ch√¨a kh√≥a
}

-- V√πng an to√†n
local SAFE_ZONES = {
    Sea1 = CFrame.new(-650, 10, 1500),
    Sea2 = CFrame.new(-380, 73, 290),
    Sea3 = CFrame.new(-5074, 314, -3151)
}

local StoreCount = {}
local CurrentTween = nil

-- // 1. H·ªÜ TH·ªêNG ANTI-KICK (CH·ªêNG AFK) //
-- T·ª± ƒë·ªông click chu·ªôt m·ªói khi game ƒë·ªãnh t√≠nh l√† AFK
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
    print(">> [ANTI-AFK] ƒê√£ k√≠ch ho·∫°t ch·ªëng vƒÉng!")
end)

-- // 2. H·ªÜ TH·ªêNG ANTI-BAN (NH·∫¨N DI·ªÜN ADMIN) //
local function CheckStaff()
    if not getgenv().Settings.StaffCheck then return end
    for _, p in pairs(Players:GetPlayers()) do
        -- ID Group c·ªßa Admin/Staff Blox Fruits
        if p:IsInGroup(1200769) or p:IsInGroup(3059674) then
            -- V√¨ S·∫øp y√™u c·∫ßu "B·ªè Hop Server", n√™n g·∫∑p Admin l√† T·ª∞ THO√ÅT lu√¥n cho an to√†n
            LocalPlayer:Kick(">> [ANTI-BAN] Ph√°t hi·ªán Admin! ƒê√£ tho√°t ƒë·ªÉ b·∫£o v·ªá acc.")
        end
    end
end

-- Qu√©t li√™n t·ª•c m·ªói khi c√≥ ng∆∞·ªùi m·ªõi v√†o
Players.PlayerAdded:Connect(CheckStaff)

-- // 3. H·ªÜ TH·ªêNG AUTO-REJOIN (T·ª∞ V√ÄO L·∫†I N·∫æU M·∫†NG LAG) //
spawn(function()
    while wait() do
        if getgenv().Settings.AutoRejoin then
            pcall(function()
                local errorPopup = CoreGui.RobloxPromptGui.promptOverlay:FindFirstChild("ErrorPrompt")
                if errorPopup and errorPopup.MessageArea.ErrorFrame.ButtonArea.ButtonLayout.Visible then
                    -- N·∫øu th·∫•y b·∫£ng b√°o l·ªói (m·∫•t k·∫øt n·ªëi) -> Rejoin
                    game:GetService("TeleportService"):Teleport(game.PlaceId)
                end
            end)
        end
    end
end)

-- // 4. H·ªÜ TH·ªêNG V·∫¨T L√ù (ƒêI TR√äN N∆Ø·ªöC) //
task.spawn(function()
    while task.wait(1) do
        pcall(function()
            local Water = Workspace.Map:FindFirstChild("WaterBase-Plane")
            if Water then
                Water.Size = Vector3.new(100000, 5, 100000)
                Water.CanCollide = true
                Water.Transparency = 0.5
            end
        end)
    end
end)

RunService.Stepped:Connect(function()
    if LocalPlayer.Character then
        for _, v in pairs(LocalPlayer.Character:GetDescendants()) do
            if v:IsA("BasePart") then v.CanCollide = false end
        end
        if LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            LocalPlayer.Character.HumanoidRootPart.Velocity = Vector3.new(0,0,0)
        end
    end
end)

-- // 5. H·ªÜ TH·ªêNG DI CHUY·ªÇN //
local function Tween(targetCFrame)
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    local HRP = LocalPlayer.Character.HumanoidRootPart
    
    -- Check Admin tr∆∞·ªõc khi bay
    CheckStaff()

    local Dist = (HRP.Position - targetCFrame.Position).Magnitude
    
    -- Logic Portal Sea 3
    if game.PlaceId == 7449423635 and Dist > 3000 then
        pcall(function() CommF:InvokeServer("requestEntrance", Vector3.new(-5074, 314, -3151)) end)
        task.wait(0.5)
    end
    
    Dist = (HRP.Position - targetCFrame.Position).Magnitude
    local Time = Dist / getgenv().Settings.TweenSpeed
    local Info = TweenInfo.new(Time, Enum.EasingStyle.Linear)
    
    if CurrentTween then CurrentTween:Cancel() end
    CurrentTween = TweenService:Create(HRP, Info, {CFrame = targetCFrame})
    CurrentTween:Play()
    CurrentTween.Completed:Wait()
    
    HRP.Velocity = Vector3.new(0,0,0)
end

-- // 6. LOGIC CH√çNH //
local function GetFruit()
    for _, v in pairs(Workspace:GetChildren()) do
        if (string.find(v.Name, "Fruit") or v:IsA("Tool")) and v:FindFirstChild("Handle") then
            return v
        end
    end
    return nil
end

local function GetChest()
    local list = {}
    for _, v in pairs(Workspace:GetDescendants()) do
        if v.Name:find("Chest") and v:IsA("Part") and v:FindFirstChild("TouchInterest") and v.Transparency < 0.8 then
            table.insert(list, v)
        end
    end
    local nearest, minDst = nil, math.huge
    local myPos = LocalPlayer.Character.HumanoidRootPart.Position
    for _, chest in pairs(list) do
        local dst = (chest.Position - myPos).Magnitude
        if dst < minDst then minDst = dst; nearest = chest end
    end
    return nearest
end

local function HasRareItem()
    local function Scan(loc)
        for _, item in pairs(loc:GetChildren()) do
            for _, rare in pairs(RARE_ITEMS) do
                if string.find(item.Name, rare) then return true end
            end
        end
        return false
    end
    if Scan(LocalPlayer.Backpack) or Scan(LocalPlayer.Character) then return true end
    return false
end

task.spawn(function()
    while task.wait() do
        if getgenv().Settings.Enable then
            pcall(function()
                -- A. FRUIT (∆ØU TI√äN S·ªê 1)
                local Fruit = GetFruit()
                if Fruit then
                    Tween(Fruit.Handle.CFrame)
                    
                    local fname = Fruit.Name
                    local count = StoreCount[fname] or 0
                    if count < getgenv().Settings.MaxStoreAttempts then
                        local success = CommF:InvokeServer("StoreFruit", "Blox Fruit", Fruit)
                        if not success then StoreCount[fname] = count + 1 end
                    end
                    return
                end
                
                -- B. RARE ITEM (∆ØU TI√äN S·ªê 2)
                if HasRareItem() then
                    local SafeSpot = SAFE_ZONES.Sea1
                    if game.PlaceId == 4442272183 then SafeSpot = SAFE_ZONES.Sea2 end
                    if game.PlaceId == 7449423635 then SafeSpot = SAFE_ZONES.Sea3 end
                    
                    Tween(SafeSpot)
                    return
                end
                
                -- C. CHEST (∆ØU TI√äN S·ªê 3)
                local Chest = GetChest()
                if Chest then
                    -- Bay th·∫≥ng v√†o t√¢m r∆∞∆°ng (V1 Style)
                    Tween(Chest.CFrame)
                else
                    -- Kh√¥ng Hop Server -> ƒê·ª©ng ch·ªù
                    task.wait(1)
                end
            end)
        end
    end
end)

-- Th√¥ng b√°o
game.StarterGui:SetCore("SendNotification", {
    Title = "CHEST V21 - FULL SAFE",
    Text = "Anti-AFK: ON | Anti-Ban: ON",
    Duration = 5
})
