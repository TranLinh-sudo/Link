--[[
    üíé AUTO CHEST V13 - FIX TO√ÄN DI·ªÜN & UI ICON
    Log: Fix r∆°i n∆∞·ªõc, Fix Server Hop, Fix delay nh·∫∑t r∆∞∆°ng.
]]

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")

local LocalPlayer = Players.LocalPlayer
local CommF = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("CommF_")

-- // C·∫§U H√åNH //
getgenv().Config = {
    AutoChest = false,       
    AutoHop = true,          
    AutoFruit = true,        
    AutoStore = true,
    Speed = 300,             
    WaterHeight = 20,        
    HopDelay = 2             
}

local IslandList = {
    {Name = "Castle on the Sea", Pos = Vector3.new(-5074, 314, -3151)},
    {Name = "Hydra Island", Pos = Vector3.new(5756, 610, -283)},
    {Name = "Floating Turtle", Pos = Vector3.new(-12463, 375, -7552)},
    {Name = "Haunted Castle", Pos = Vector3.new(-9548, 142, 5536)},
    {Name = "Port Town", Pos = Vector3.new(-265, 9, 5335)},
    {Name = "Great Tree", Pos = Vector3.new(2356, 30, -6940)},
    {Name = "Candy Island", Pos = Vector3.new(-1111, 15, -14344)}
}

local CurrentIslandIndex = 1
local EmptyCount = 0
local CurrentTween = nil

-- // 1. GIAO DI·ªÜN (C√ì ICON B·∫¨T T·∫ÆT) //
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local OpenButton = Instance.new("ImageButton") -- N√∫t Icon
local UICorner = Instance.new("UICorner")

if gethui then ScreenGui.Parent = gethui() else ScreenGui.Parent = CoreGui end
ScreenGui.Name = "ChestV13_Fixed"

-- N√∫t Icon (Logo)
OpenButton.Parent = ScreenGui
OpenButton.Position = UDim2.new(0, 10, 0.5, 0)
OpenButton.Size = UDim2.new(0, 50, 0, 50)
OpenButton.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
OpenButton.Image = "http://www.roblox.com/asset/?id=13399485856" -- Logo Fruit
OpenButton.Active = true
OpenButton.Draggable = true

local corner1 = Instance.new("UICorner", OpenButton); corner1.CornerRadius = UDim.new(0, 100)
local stroke = Instance.new("UIStroke", OpenButton); stroke.Color = Color3.fromRGB(0, 255, 255); stroke.Thickness = 2

-- B·∫£ng Menu Ch√≠nh
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
MainFrame.Position = UDim2.new(0.1, 0, 0.2, 0)
MainFrame.Size = UDim2.new(0, 260, 0, 200)
MainFrame.Visible = true -- Hi·ªán l√∫c ƒë·∫ßu
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.BorderSizePixel = 0

local corner2 = Instance.new("UICorner", MainFrame); corner2.CornerRadius = UDim.new(0, 10)

-- C√°c th√†nh ph·∫ßn trong Menu
local Title = Instance.new("TextLabel", MainFrame)
Title.Size = UDim2.new(1, 0, 0, 35)
Title.BackgroundTransparency = 1
Title.Text = "CHEST V13 (FIXED)"
Title.TextColor3 = Color3.fromRGB(0, 255, 255)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 18

local ToggleBtn = Instance.new("TextButton", MainFrame)
ToggleBtn.Position = UDim2.new(0.1, 0, 0.25, 0)
ToggleBtn.Size = UDim2.new(0.8, 0, 0.25, 0)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
ToggleBtn.Text = "üî¥ FARM: T·∫ÆT"
ToggleBtn.Font = Enum.Font.SourceSansBold
ToggleBtn.TextSize = 16
ToggleBtn.TextColor3 = Color3.new(1,1,1)
local c3 = Instance.new("UICorner", ToggleBtn); c3.CornerRadius = UDim.new(0, 6)

local HopBtn = Instance.new("TextButton", MainFrame)
HopBtn.Position = UDim2.new(0.1, 0, 0.55, 0)
HopBtn.Size = UDim2.new(0.8, 0, 0.2, 0)
HopBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
HopBtn.Text = "üü¢ AUTO HOP: B·∫¨T"
HopBtn.Font = Enum.Font.SourceSansBold
HopBtn.TextSize = 14
HopBtn.TextColor3 = Color3.new(1,1,1)
local c4 = Instance.new("UICorner", HopBtn); c4.CornerRadius = UDim.new(0, 6)

local Status = Instance.new("TextLabel", MainFrame)
Status.Position = UDim2.new(0, 10, 0.8, 0)
Status.Size = UDim2.new(1, -20, 0.2, 0)
Status.BackgroundTransparency = 1
Status.TextColor3 = Color3.new(1,1,0)
Status.Text = "S·∫µn s√†ng..."
Status.TextSize = 12
Status.Font = Enum.Font.Code

local CloseBtn = Instance.new("TextButton", MainFrame)
CloseBtn.Size = UDim2.new(0, 30, 0, 30)
CloseBtn.Position = UDim2.new(1, -30, 0, 0)
CloseBtn.BackgroundTransparency = 1
CloseBtn.Text = "X"
CloseBtn.TextColor3 = Color3.new(1,0,0)
CloseBtn.TextSize = 18
CloseBtn.Font = Enum.Font.SourceSansBold

-- X·ª≠ l√Ω ƒë√≥ng/m·ªü menu
OpenButton.MouseButton1Click:Connect(function() MainFrame.Visible = not MainFrame.Visible end)
CloseBtn.MouseButton1Click:Connect(function() MainFrame.Visible = false end)

-- // 2. H·ªÜ TH·ªêNG DI CHUY·ªÇN M·ªöI (FIX L·ªñI R∆†I N∆Ø·ªöC) //
local BodyVel = nil
local function EnableFloat()
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    local HRP = LocalPlayer.Character.HumanoidRootPart
    
    -- T·∫°o l·ª±c n√¢ng ƒë·ªÉ kh√¥ng b·ªã r∆°i
    if not HRP:FindFirstChild("AntiFall") then
        BodyVel = Instance.new("BodyVelocity")
        BodyVel.Name = "AntiFall"
        BodyVel.Parent = HRP
        BodyVel.Velocity = Vector3.new(0, 0, 0)
        BodyVel.MaxForce = Vector3.new(100000, 100000, 100000)
    end
end

local function DisableFloat()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local bf = LocalPlayer.Character.HumanoidRootPart:FindFirstChild("AntiFall")
        if bf then bf:Destroy() end
    end
end

local function Tween(targetPos)
    if not LocalPlayer.Character then return end
    local HRP = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not HRP then return end

    EnableFloat() -- B·∫≠t ch·∫ø ƒë·ªô bay (kh√¥ng r∆°i)

    local Distance = (HRP.Position - targetPos).Magnitude
    local Time = Distance / getgenv().Config.Speed
    
    -- T·ªëi ∆∞u ƒë∆∞·ªùng bay: Bay cao h∆°n ƒë√≠ch ƒë·∫øn m·ªôt ch√∫t ƒë·ªÉ kh√¥ng ƒë√¢m v√†o ƒë·∫•t
    local Info = TweenInfo.new(Time, Enum.EasingStyle.Linear)
    
    if CurrentTween then CurrentTween:Cancel() end
    CurrentTween = TweenService:Create(HRP, Info, {CFrame = CFrame.new(targetPos)})
    CurrentTween:Play()
    
    local Completed = false
    local Con
    Con = CurrentTween.Completed:Connect(function()
        Completed = true
        Con:Disconnect()
    end)
    
    -- Noclip li√™n t·ª•c
    local NoclipLoop = RunService.Stepped:Connect(function()
        if LocalPlayer.Character then
            for _, v in pairs(LocalPlayer.Character:GetDescendants()) do
                if v:IsA("BasePart") then v.CanCollide = false end
            end
        end
        -- Ki·ªÉm tra n·∫øu ƒë·∫øn g·∫ßn ƒë√≠ch th√¨ d·ª´ng s·ªõm (Fix l·ªói k·∫πt)
        if (HRP.Position - targetPos).Magnitude < 5 then
            if CurrentTween then CurrentTween:Cancel() end
            Completed = true
        end
    end)
    
    while not Completed and getgenv().Config.AutoChest do task.wait() end
    NoclipLoop:Disconnect()
    -- Kh√¥ng t·∫Øt Float ngay ƒë·ªÉ tr√°nh r∆°i xu·ªëng n∆∞·ªõc khi t√¨m r∆∞∆°ng m·ªõi
end

-- // 3. H·ªÜ TH·ªêNG HOP SERVER V2 (FIX L·ªñI KH√îNG ƒê·ªîI ƒê∆Ø·ª¢C) //
local function HopServer()
    Status.Text = "‚è≥ ƒêang t√¨m Server ngon..."
    
    local function Hop()
        local PlaceID = game.PlaceId
        local AllIDs = {}
        local Model = HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. PlaceID .. "/servers/Public?sortOrder=Asc&limit=100"))
        for i, v in pairs(Model.data) do
            if v.playing < v.maxPlayers and v.id ~= game.JobId then
                table.insert(AllIDs, v.id)
            end
        end
        
        if #AllIDs > 0 then
            Status.Text = "üöÄ ƒêang k·∫øt n·ªëi Server m·ªõi..."
            TeleportService:TeleportToPlaceInstance(PlaceID, AllIDs[math.random(1, #AllIDs)], LocalPlayer)
        else
            Status.Text = "‚ùå Kh√¥ng t√¨m th·∫•y Server! Th·ª≠ l·∫°i..."
            wait(2)
            Hop() -- Th·ª≠ l·∫°i ƒë·ªá quy
        end
    end
    
    pcall(function() Hop() end)
end

-- // 4. LOGIC T√åM R∆Ø∆†NG T·ªêI ∆ØU //
local function GetNearestChest()
    local HRP = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not HRP then return nil end
    
    local nearest = nil
    local minDist = math.huge
    
    -- Qu√©t t·∫•t c·∫£, bao g·ªìm c·∫£ r∆∞∆°ng m·ªõi spawn
    for _, v in pairs(Workspace:GetDescendants()) do
        if v.Name:find("Chest") and v:IsA("Part") and v:FindFirstChild("TouchInterest") then
             -- Ch·ªâ nh·∫∑t r∆∞∆°ng nh√¨n th·∫•y ƒë∆∞·ª£c (Transparency < 1)
            if v.Transparency < 0.8 then 
                local dist = (v.Position - HRP.Position).Magnitude
                if dist < minDist then
                    minDist = dist
                    nearest = v
                end
            end
        end
    end
    return nearest
end

-- H√†m ƒë·ªïi ƒë·∫£o
local function HopToNextIsland()
    CurrentIslandIndex = CurrentIslandIndex + 1
    if CurrentIslandIndex > #IslandList then CurrentIslandIndex = 1 end
    local NextIsland = IslandList[CurrentIslandIndex]
    
    EmptyCount = EmptyCount + 1
    Status.Text = "ƒê·∫£o tr·ªëng! Sang: " .. NextIsland.Name
    
    -- Hop Server n·∫øu 3 ƒë·∫£o li√™n ti·∫øp kh√¥ng c√≥ r∆∞∆°ng
    if EmptyCount >= 3 and getgenv().Config.AutoHop then
        HopServer()
        return
    end
    
    -- D√πng C·ªïng
    local args = {[1] = "requestEntrance", [2] = NextIsland.Pos}
    pcall(function() CommF:InvokeServer(unpack(args)) end)
    
    task.wait(0.5)
    local HRP = LocalPlayer.Character.HumanoidRootPart
    if (HRP.Position - NextIsland.Pos).Magnitude > 1000 then
        -- Bay cao 300m ƒë·ªÉ sang ƒë·∫£o
        Tween(Vector3.new(HRP.Position.X, 300, HRP.Position.Z)) 
        Tween(Vector3.new(NextIsland.Pos.X, 300, NextIsland.Pos.Z))
    end
end

-- // 5. V√íNG L·∫∂P CH√çNH //
task.spawn(function()
    while task.wait() do
        if getgenv().Config.AutoChest then
            pcall(function()
                -- T√¨m r∆∞∆°ng
                local Chest = GetNearestChest()
                
                if Chest then
                    Status.Text = "üí∞ Nh·∫∑t: " .. Chest.Name
                    EmptyCount = 0 -- Reset ƒë·∫øm l·ªói
                    
                    local TargetPos = Chest.Position
                    local HRP = LocalPlayer.Character.HumanoidRootPart
                    
                    -- Logic bay:
                    if (HRP.Position - TargetPos).Magnitude > 50 then
                        -- N·∫øu xa: Bay ·ªü ƒë·ªô cao WaterHeight (25m)
                        -- Gi·ªØ nguy√™n X, Z c·ªßa r∆∞∆°ng, ch·ªâ thay ƒë·ªïi Y
                        local SafeY = math.max(TargetPos.Y, getgenv().Config.WaterHeight)
                        Tween(Vector3.new(TargetPos.X, SafeY, TargetPos.Z))
                    end
                    
                    -- Lao v√†o r∆∞∆°ng
                    Tween(TargetPos)
                else
                    HopToNextIsland()
                    task.wait(getgenv().Config.HopDelay)
                end
            end)
        else
            DisableFloat() -- T·∫Øt ch·∫ø ƒë·ªô bay
            if CurrentTween then CurrentTween:Cancel() end
        end
    end
end)

-- X·ª≠ l√Ω n√∫t b·∫•m
ToggleBtn.MouseButton1Click:Connect(function()
    getgenv().Config.AutoChest = not getgenv().Config.AutoChest
    if getgenv().Config.AutoChest then
        ToggleBtn.Text = "üü¢ FARM: B·∫¨T"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
    else
        ToggleBtn.Text = "üî¥ FARM: T·∫ÆT"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        Status.Text = "ƒê√£ d·ª´ng."
    end
end)

HopBtn.MouseButton1Click:Connect(function()
    getgenv().Config.AutoHop = not getgenv().Config.AutoHop
    if getgenv().Config.AutoHop then
        HopBtn.Text = "üü¢ AUTO HOP: B·∫¨T"
        HopBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
    else
        HopBtn.Text = "üî¥ AUTO HOP: T·∫ÆT"
        HopBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    end
end)

-- Anti-AFK
VirtualUser:CaptureController()
LocalPlayer.Idled:Connect(function() VirtualUser:ClickButton2(Vector2.new()) end)
