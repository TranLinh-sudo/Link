--[[
    üíé AUTO CHEST V12 - THE ULTIMATE COLLECTOR (FINAL)
    Dev: Gemini & User
    T√≠nh nƒÉng:
    1. Fruit Sniper (∆Øu ti√™n s·ªë 1): Nh·∫∑t tr√°i v√† Gacha.
    2. Smart Store: C·∫•t tr√°i th√¥ng minh, kh√¥ng spam.
    3. Safe Haven: T·ª± ƒë·ªông v·ªÅ nh√† an to√†n khi c√≥ ƒë·ªì hi·∫øm.
    4. Global Farm: T·ª± ƒë·ªông ƒë·ªïi ƒë·∫£o, ƒë·ªïi server khi h·∫øt r∆∞∆°ng.
    5. Guardian: N√© Admin, Ch·ªëng Kick, Anti-AFK.
]]

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")

local LocalPlayer = Players.LocalPlayer
local CommF = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("CommF_")

-- // C·∫§U H√åNH M·∫∂C ƒê·ªäNH //
getgenv().Config = {
    AutoChest = false,       -- C√¥ng t·∫Øc t·ªïng
    AutoHop = true,          -- T·ª± ƒë·ªïi server khi ƒë√≥i
    AutoFruit = true,        -- T·ª± nh·∫∑t tr√°i
    AutoGacha = true,        -- T·ª± random tr√°i
    AutoStore = true,        -- T·ª± c·∫•t tr√°i
    StopOnRare = true,       -- D·ª´ng khi c√≥ ƒë·ªì hi·∫øm
    StaffHop = true,         -- N√© Admin
    Speed = 290,             -- T·ªëc ƒë·ªô bay an to√†n
    WaterHeight = 25,        -- ƒê·ªô cao n√© n∆∞·ªõc
    HopDelay = 1.5
}

-- DANH S√ÅCH B√ÅO ƒê·ªòNG (C·∫¶M L√Ä PH·∫¢I V·ªÄ NH√Ä NGAY)
local RARE_ITEMS = {
    "God's Chalice", "Fist of Darkness", "Sweet Chalice", 
    "Hellfire Torch", "Hidden Key", "Library Key", "Key", "Game Pass"
}

-- C√ÅC ƒêI·ªÇM AN TO√ÄN (SAFE ZONES)
local SAFE_ZONES = {
    Sea1 = Vector3.new(-650, 10, 1500),  -- Middle Town
    Sea2 = Vector3.new(-380, 73, 290),   -- The Cafe
    Sea3 = Vector3.new(-5074, 314, -3151)-- Castle on the Sea
}

-- L·ªò TR√åNH BAY (SEA 3)
local IslandList = {
    {Name = "Castle on the Sea", Pos = Vector3.new(-5074, 314, -3151)},
    {Name = "Hydra Island", Pos = Vector3.new(5756, 610, -283)},
    {Name = "Floating Turtle", Pos = Vector3.new(-12463, 375, -7552)},
    {Name = "Haunted Castle", Pos = Vector3.new(-9548, 142, 5536)},
    {Name = "Port Town", Pos = Vector3.new(-265, 9, 5335)},
    {Name = "Great Tree", Pos = Vector3.new(2356, 30, -6940)},
    {Name = "Candy Island", Pos = Vector3.new(-1111, 15, -14344)}
}

local CurrentIslandIndex = 1
local EmptyCount = 0
local CurrentTween = nil
local StoreAttempts = {} -- ƒê·∫øm s·ªë l·∫ßn c·∫•t tr√°i th·∫•t b·∫°i

-- // 1. GIAO DI·ªÜN ƒêI·ªÄU KHI·ªÇN (GUI) //
local ScreenGui = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local ToggleBtn = Instance.new("TextButton")
local Status = Instance.new("TextLabel")
local SubStatus = Instance.new("TextLabel")
local UICorner = Instance.new("UICorner")

if gethui then ScreenGui.Parent = gethui() else ScreenGui.Parent = CoreGui end
ScreenGui.Name = "UltimateCollector_V12"

Frame.Parent = ScreenGui
Frame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
Frame.Position = UDim2.new(0.05, 0, 0.2, 0)
Frame.Size = UDim2.new(0, 280, 0, 200)
Frame.Active = true
Frame.Draggable = true
Frame.BorderSizePixel = 2
Frame.BorderColor3 = Color3.fromRGB(0, 255, 200)

Title.Parent = Frame
Title.BackgroundColor3 = Color3.fromRGB(0, 150, 150)
Title.Size = UDim2.new(1, 0, 0, 35)
Title.Text = "üíé ULTIMATE V12"
Title.TextColor3 = Color3.new(1,1,1)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 18

ToggleBtn.Parent = Frame
ToggleBtn.Position = UDim2.new(0.1, 0, 0.25, 0)
ToggleBtn.Size = UDim2.new(0.8, 0, 0.3, 0)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
ToggleBtn.Text = "üî¥ TR·∫†NG TH√ÅI: T·∫ÆT"
ToggleBtn.Font = Enum.Font.SourceSansBold
ToggleBtn.TextSize = 16
ToggleBtn.TextColor3 = Color3.new(1,1,1)
local btnCorner = Instance.new("UICorner", ToggleBtn); btnCorner.CornerRadius = UDim.new(0,6)

Status.Parent = Frame
Status.BackgroundTransparency = 1
Status.Position = UDim2.new(0, 10, 0.6, 0)
Status.Size = UDim2.new(1, -20, 0.2, 0)
Status.TextColor3 = Color3.fromRGB(255, 255, 0)
Status.Text = "Ch·ªù l·ªánh..."
Status.TextWrapped = true
Status.Font = Enum.Font.Code
Status.TextSize = 13

SubStatus.Parent = Frame
SubStatus.BackgroundTransparency = 1
SubStatus.Position = UDim2.new(0, 10, 0.8, 0)
SubStatus.Size = UDim2.new(1, -20, 0.2, 0)
SubStatus.TextColor3 = Color3.fromRGB(200, 200, 200)
SubStatus.Text = "Safe Mode: Ready"
SubStatus.Font = Enum.Font.Code
SubStatus.TextSize = 12

-- // 2. H·ªÜ TH·ªêNG AN TO√ÄN (ANTI-AFK & REJOIN) //
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- // 3. H·ªÜ TH·ªêNG DI CHUY·ªÇN (SMART TWEEN) //
local function Tween(targetPos)
    if not LocalPlayer.Character then return end
    local HRP = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not HRP then return end

    local Distance = (HRP.Position - targetPos).Magnitude
    local Time = Distance / getgenv().Config.Speed
    local Info = TweenInfo.new(Time, Enum.EasingStyle.Linear)
    
    if CurrentTween then CurrentTween:Cancel() end
    CurrentTween = TweenService:Create(HRP, Info, {CFrame = CFrame.new(targetPos)})
    CurrentTween:Play()
    
    -- Noclip (Xuy√™n t∆∞·ªùng)
    local NoclipConn
    NoclipConn = RunService.Stepped:Connect(function()
        if LocalPlayer.Character then
            for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
                if part:IsA("BasePart") then part.CanCollide = false end
            end
            -- Gi·ªØ ƒë·ªô cao (Anti-Fall)
            if LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                LocalPlayer.Character.HumanoidRootPart.Velocity = Vector3.new(0,0,0)
            end
        end
    end)
    
    -- Ch·ªù bay xong ho·∫∑c b·ªã h·ªßy
    local Completed = false
    CurrentTween.Completed:Connect(function() Completed = true end)
    
    while not Completed and getgenv().Config.AutoChest do task.wait() end
    
    NoclipConn:Disconnect()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        LocalPlayer.Character.HumanoidRootPart.Velocity = Vector3.new(0,0,0) -- Phanh l·∫°i khi ƒë·∫øn n∆°i
    end
end

-- // 4. H·ªÜ TH·ªêNG V·ªÄ NH√Ä (SAFE ZONE) //
local function GoToSafeZone()
    getgenv().Config.AutoChest = false -- T·∫Øt farm
    
    Status.Text = "üö® C√ì ƒê·ªí HI·∫æM! V·ªÄ NH√Ä..."
    ToggleBtn.Text = "‚ö†Ô∏è ƒê√É D·ª™NG (B·∫¢O V·ªÜ ƒê·ªí)"
    ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 140, 0)

    local PlaceId = game.PlaceId
    local SafePos = SAFE_ZONES.Sea1
    if PlaceId == 7449423635 then SafePos = SAFE_ZONES.Sea3
    elseif PlaceId == 4442272183 then SafePos = SAFE_ZONES.Sea2 end
    
    local HRP = LocalPlayer.Character.HumanoidRootPart
    -- Bay cao ƒë·ªÉ n√© combat
    if (HRP.Position - SafePos).Magnitude > 300 then
        Tween(Vector3.new(HRP.Position.X, 400, HRP.Position.Z))
        Tween(Vector3.new(SafePos.X, 400, SafePos.Z))
    end
    Tween(SafePos)
    
    Status.Text = "‚úÖ ƒê√É V·ªÄ V√ôNG AN TO√ÄN"
    SubStatus.Text = "Tr·∫°ng th√°i: AFK (Neo nh√¢n v·∫≠t)"
    HRP.Anchored = true -- ƒê·ª©ng im tuy·ªát ƒë·ªëi
end

-- // 5. H·ªÜ TH·ªêNG QU√âT ƒê·ªí (SCANNER) //
local function CheckInventory()
    if not getgenv().Config.StopOnRare then return false end
    
    local function ScanList(list)
        for _, item in pairs(list) do
            for _, rare in pairs(RARE_ITEMS) do
                if string.find(item.Name, rare) then
                    GoToSafeZone()
                    return true
                end
            end
        end
        return false
    end
    
    if ScanList(LocalPlayer.Backpack:GetChildren()) then return true end
    if LocalPlayer.Character and ScanList(LocalPlayer.Character:GetChildren()) then return true end
    return false
end

LocalPlayer.Backpack.ChildAdded:Connect(function() CheckInventory() end)

-- // 6. H·ªÜ TH·ªêNG TR√ÅI C√ÇY (FRUIT MANAGER) //
local function SmartStoreFruit()
    if not getgenv().Config.AutoStore then return end
    for _, item in pairs(LocalPlayer.Backpack:GetChildren()) do
        if item:IsA("Tool") and string.find(item.Name, "Fruit") then
            local attempts = StoreAttempts[item.Name] or 0
            if attempts < 2 then
                local args = {[1] = "StoreFruit", [2] = "Blox Fruit", [3] = item}
                if CommF:InvokeServer(unpack(args)) then
                    StoreAttempts[item.Name] = nil
                    SubStatus.Text = "‚úÖ ƒê√£ c·∫•t: " .. item.Name
                else
                    StoreAttempts[item.Name] = attempts + 1
                    SubStatus.Text = "‚ö†Ô∏è C·∫•t l·ªói: " .. item.Name
                end
            end
        end
    end
end

local function AutoGacha()
    if not getgenv().Config.AutoGacha then return end
    local args = {[1] = "Cousin", [2] = "Buy"}
    local res = CommF:InvokeServer(unpack(args))
    if type(res) == "table" then
        SubStatus.Text = "üéÅ Gacha: " .. res.Name
        SmartStoreFruit()
    end
end

local function GetNearestFruit()
    local HRP = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    local nearest, minDist = nil, math.huge
    for _, v in pairs(Workspace:GetChildren()) do
        if (string.find(v.Name, "Fruit") or string.find(v.Name, "Model")) and v:FindFirstChild("Handle") then
            local dist = (v.Handle.Position - HRP.Position).Magnitude
            if dist < minDist then minDist = dist; nearest = v end
        end
    end
    return nearest
end

-- // 7. H·ªÜ TH·ªêNG FARM & HOP //
local function GetChest()
    local HRP = LocalPlayer.Character.HumanoidRootPart
    local nearest, minDist = nil, math.huge
    for _, v in pairs(Workspace:GetDescendants()) do
        if v.Name:find("Chest") and v:IsA("Part") and v:FindFirstChild("TouchInterest") and v.Transparency < 1 then
            local dist = (v.Position - HRP.Position).Magnitude
            if dist < minDist then minDist = dist; nearest = v end
        end
    end
    return nearest
end

local function HopServer()
    Status.Text = "‚è≥ ƒêang t√¨m Server..."
    local PlaceID = game.PlaceId
    local AllIDs = {}
    local foundAnything = ""
    local actualHour = os.date("!*t").hour
    
    local function TPReturner()
        local Site;
        if foundAnything == "" then
            Site = HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100'))
        else
            Site = HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100&cursor=' .. foundAnything))
        end
        if Site.nextPageCursor and Site.nextPageCursor ~= "null" and Site.nextPageCursor ~= nil then
            foundAnything = Site.nextPageCursor
        end
        for i,v in pairs(Site.data) do
            local Possible = true
            local ID = tostring(v.id)
            if tonumber(v.maxPlayers) > tonumber(v.playing) then
                for _,Existing in pairs(AllIDs) do
                    if num ~= 0 then
                        if ID == tostring(Existing) then Possible = false end
                    else
                        if tonumber(actualHour) ~= tonumber(Existing) then
                            local delFile = pcall(function()
                                delfile("NotSameServers.json")
                                AllIDs = {}
                                table.insert(AllIDs, actualHour)
                            end)
                        end
                    end
                    num = num + 1
                end
                if Possible == true then
                    table.insert(AllIDs, ID)
                    wait()
                    pcall(function()
                        Status.Text = "üöÄ ƒêang qua Server m·ªõi..."
                        TeleportService:TeleportToPlaceInstance(PlaceID, ID, LocalPlayer)
                    end)
                    wait(4)
                end
            end
        end
    end
    TPReturner()
end

-- // 8. LOGIC CH√çNH (MAIN LOOP) //
task.spawn(function()
    while task.wait() do
        if getgenv().Config.AutoChest then
            -- Ki·ªÉm tra Admin
            if getgenv().Config.StaffHop then
                for _, p in pairs(Players:GetPlayers()) do
                    if p:IsInGroup(1200769) or p:IsInGroup(3059674) then
                        if not CheckInventory() then HopServer() end
                    end
                end
            end

            -- N·∫øu kh√¥ng c√≥ ƒë·ªì hi·∫øm th√¨ m·ªõi l√†m vi·ªác
            if not CheckInventory() then
                pcall(function()
                    -- 1. Gacha & Store
                    AutoGacha()
                    SmartStoreFruit()
                    
                    -- 2. T√¨m Fruit (∆Øu ti√™n)
                    local Fruit = GetNearestFruit()
                    if Fruit and getgenv().Config.AutoFruit then
                        Status.Text = "üî• NH·∫∂T TR√ÅI: " .. Fruit.Name
                        Status.TextColor3 = Color3.fromRGB(255, 0, 0)
                        Tween(Fruit.Handle.Position)
                        task.wait(0.5)
                        SmartStoreFruit()
                    else
                        -- 3. T√¨m R∆∞∆°ng
                        local Chest = GetChest()
                        if Chest then
                            Status.Text = "Nh·∫∑t: " .. Chest.Name
                            Status.TextColor3 = Color3.new(1,1,1)
                            EmptyCount = 0
                            
                            local MyPos = LocalPlayer.Character.HumanoidRootPart.Position
                            if (MyPos - Chest.Position).Magnitude > 50 then
                                local FlyPos = Vector3.new(Chest.Position.X, math.max(Chest.Position.Y, getgenv().Config.WaterHeight), Chest.Position.Z)
                                Tween(FlyPos)
                            else
                                Tween(Chest.Position)
                            end
                        else
                            -- 4. H·∫øt r∆∞∆°ng -> ƒê·ªïi ƒë·∫£o -> ƒê·ªïi Server
                            EmptyCount = EmptyCount + 1
                            CurrentIslandIndex = CurrentIslandIndex + 1
                            if CurrentIslandIndex > #IslandList then CurrentIslandIndex = 1 end
                            local NextIsland = IslandList[CurrentIslandIndex]
                            
                            Status.Text = "ƒê·ªïi ƒë·∫£o: " .. NextIsland.Name
                            if EmptyCount >= 3 and getgenv().Config.AutoHop then
                                HopServer()
                                task.wait(10)
                            else
                                CommF:InvokeServer("requestEntrance", NextIsland.Pos)
                                task.wait(0.5)
                                local HRP = LocalPlayer.Character.HumanoidRootPart
                                if (HRP.Position - NextIsland.Pos).Magnitude > 1000 then
                                    Tween(Vector3.new(HRP.Position.X, 300, HRP.Position.Z)) 
                                    Tween(Vector3.new(NextIsland.Pos.X, 300, NextIsland.Pos.Z))
                                end
                            end
                        end
                    end
                end)
            end
        else
            if CurrentTween then CurrentTween:Cancel() end
        end
    end
end)

-- N√∫t B·∫≠t T·∫Øt
ToggleBtn.MouseButton1Click:Connect(function()
    if CheckInventory() then return end
    getgenv().Config.AutoChest = not getgenv().Config.AutoChest
    if getgenv().Config.AutoChest then
        ToggleBtn.Text = "üü¢ CH·∫†Y: ON"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
    else
        ToggleBtn.Text = "üî¥ D·ª™NG: OFF"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        Status.Text = "ƒê√£ d·ª´ng."
    end
end)
