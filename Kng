--[[ 
    DATA MINER V5 PRO - UPVALUE SCANNER + PROGRESS BAR
    Chức năng: Quét sâu vào hàm số, hiện thanh tiến độ và % chi tiết.
]]

local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local FileName = "TEDDY_DEEP_DATA.txt"

-- 1. GIAO DIỆN TRẠNG THÁI (HUD PRO)
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local StatusLabel = Instance.new("TextLabel")
local BarContainer = Instance.new("Frame")
local BarFill = Instance.new("Frame")
local PercentText = Instance.new("TextLabel")
local CloseBtn = Instance.new("TextButton")

if gethui then ScreenGui.Parent = gethui() else ScreenGui.Parent = game.CoreGui end
ScreenGui.Name = "DeepMinerPro"

-- Khung chính
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
MainFrame.Position = UDim2.new(0.5, -150, 0.1, 0)
MainFrame.Size = UDim2.new(0, 300, 0, 130)
MainFrame.BorderSizePixel = 2
MainFrame.BorderColor3 = Color3.fromRGB(170, 0, 255) -- Viền tím neon
MainFrame.Active = true
MainFrame.Draggable = true

-- Tiêu đề
Title.Parent = MainFrame
Title.BackgroundTransparency = 1
Title.Size = UDim2.new(1, 0, 0, 30)
Title.Text = "QUÉT SÂU UPVALUES (V5)"
Title.TextColor3 = Color3.fromRGB(170, 0, 255)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 18

-- Trạng thái
StatusLabel.Parent = MainFrame
StatusLabel.BackgroundTransparency = 1
StatusLabel.Position = UDim2.new(0, 10, 0, 35)
StatusLabel.Size = UDim2.new(1, -20, 0, 35)
StatusLabel.Text = "Đang khởi tạo..."
StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
StatusLabel.Font = Enum.Font.Code
StatusLabel.TextSize = 13
StatusLabel.TextWrapped = true
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left

-- Thanh chứa
BarContainer.Parent = MainFrame
BarContainer.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
BarContainer.Position = UDim2.new(0, 10, 0, 80)
BarContainer.Size = UDim2.new(1, -20, 0, 15)
BarContainer.BorderSizePixel = 0

-- Thanh chạy
BarFill.Parent = BarContainer
BarFill.BackgroundColor3 = Color3.fromRGB(170, 0, 255) -- Tím
BarFill.Size = UDim2.new(0, 0, 1, 0)
BarFill.BorderSizePixel = 0

-- Số %
PercentText.Parent = BarContainer
PercentText.BackgroundTransparency = 1
PercentText.Size = UDim2.new(1, 0, 1, 0)
PercentText.Font = Enum.Font.SourceSansBold
PercentText.Text = "0%"
PercentText.TextColor3 = Color3.new(1, 1, 1)
PercentText.TextSize = 12
PercentText.ZIndex = 2

-- Nút Đóng
CloseBtn.Parent = MainFrame
CloseBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
CloseBtn.Position = UDim2.new(0, 0, 1, -30)
CloseBtn.Size = UDim2.new(1, 0, 0, 30)
CloseBtn.Text = "HỦY / ĐÓNG"
CloseBtn.TextColor3 = Color3.new(1,1,1)
CloseBtn.Font = Enum.Font.SourceSansBold
CloseBtn.MouseButton1Click:Connect(function() ScreenGui:Destroy() end)

-- 2. HÀM LÀM SẠCH DỮ LIỆU
local function Clean(v)
    if typeof(v) == "CFrame" then return tostring(v)
    elseif typeof(v) == "Vector3" then return tostring(v)
    elseif type(v) == "table" then return "{Table...}"
    else return tostring(v) end
end

-- 3. HÀM KIỂM TRA DỮ LIỆU (TARGET)
local function IsTarget(val)
    if type(val) == "string" then
        -- Tìm các từ khóa cứng
        if string.find(val, "Bandit") or string.find(val, "Quest") or string.find(val, "Tushita") or string.find(val, "CFrame") then
            return true
        end
    elseif type(val) == "table" then
        -- Nếu là bảng, kiểm tra bên trong bảng
        for k, v in pairs(val) do
            if type(v) == "string" and (string.find(v, "Bandit") or string.find(v, "Quest")) then
                return true
            end
            if tostring(k) == "Mon" or tostring(k) == "CFrameQuest" then
                return true
            end
        end
    end
    return false
end

-- 4. LOGIC QUÉT CHÍNH
task.spawn(function()
    if not debug.getupvalues or not getgc then
        StatusLabel.Text = "❌ LỖI: Executor yếu quá!"
        StatusLabel.TextColor3 = Color3.new(1,0,0)
        return
    end

    StatusLabel.Text = "Đang tập hợp dữ liệu RAM..."
    RunService.Heartbeat:Wait()

    local Output = "=== DỮ LIỆU TÌM ĐƯỢC TỪ UPVALUES ===\n\n"
    local FoundCount = 0
    local Scanned = 0
    
    -- Lấy tất cả đối tượng (Có thể lag 1 giây)
    local gcObjects = getgc()
    local total = #gcObjects
    
    for i, func in pairs(gcObjects) do
        Scanned = Scanned + 1
        
        -- Cập nhật giao diện (Mỗi 500 cái cập nhật 1 lần)
        if Scanned % 500 == 0 then
            local p = Scanned / total
            BarFill:TweenSize(UDim2.new(p, 0, 1, 0), "Out", "Linear", 0.1)
            PercentText.Text = math.floor(p * 100) .. "%"
            StatusLabel.Text = string.format("Đang soi hàm: %d / %d\nTìm thấy: %d dữ liệu", Scanned, total, FoundCount)
            RunService.Heartbeat:Wait()
        end

        -- Chỉ kiểm tra Hàm Lua
        if type(func) == "function" and islclosure(func) and not is_synapse_function(func) then
            local upvalues = debug.getupvalues(func)
            
            for k, val in pairs(upvalues) do
                if IsTarget(val) then
                    FoundCount = FoundCount + 1
                    
                    -- Lưu lại
                    Output = Output .. "--- [TRONG HÀM #" .. i .. "] ---\n"
                    
                    if type(val) == "table" then
                        Output = Output .. "Loại: TABLE\n"
                        for subK, subV in pairs(val) do
                            pcall(function()
                                Output = Output .. "   [" .. tostring(subK) .. "] = " .. Clean(subV) .. "\n"
                            end)
                        end
                    else
                        Output = Output .. "Giá trị: " .. Clean(val) .. "\n"
                    end
                    Output = Output .. "\n"
                end
            end
        end
    end
    
    -- HOÀN TẤT
    BarFill.Size = UDim2.new(1, 0, 1, 0)
    PercentText.Text = "100%"
    
    if FoundCount > 0 then
        writefile(FileName, Output)
        
        Title.Text = "✅ QUÉT THÀNH CÔNG!"
        StatusLabel.Text = "Đã lưu " .. FoundCount .. " dữ liệu ẩn.\nTên file: " .. FileName
        StatusLabel.TextColor3 = Color3.new(0, 1, 0)
        MainFrame.BorderColor3 = Color3.new(0, 1, 0)
        CloseBtn.BackgroundColor3 = Color3.new(0, 0.6, 0)
        CloseBtn.Text = "XONG - ĐÓNG TOOL"
    else
        Title.Text = "⚠️ KHÔNG TÌM THẤY"
        StatusLabel.Text = "Script này giấu quá kỹ hoặc chưa nạp dữ liệu."
        StatusLabel.TextColor3 = Color3.new(1, 0, 0)
        MainFrame.BorderColor3 = Color3.new(1, 0, 0)
    end
end)
