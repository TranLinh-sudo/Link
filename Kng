--[[
    üíé AUTO CHEST V20 - POSEIDON EDITION
    Ch·ª©c nƒÉng:
    - Bi·∫øn n∆∞·ªõc th√†nh s√†n c·ª©ng v√¥ h√¨nh (ƒêi b·ªô tr√™n bi·ªÉn).
    - Farm R∆∞∆°ng/Tr√°i t·ª± ƒë·ªông.
    - G·ªçn nh·∫π, kh√¥ng c√≥ r√°c tr√™n m√†n h√¨nh.
]]

getgenv().ChestV20_Running = true
getgenv().Config = {
    AutoChest = false,
    AutoHop = true,
    AutoFruit = true,
    Speed = 300,
    HopDelay = 2
}

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")

local LocalPlayer = Players.LocalPlayer
local CurrentTween = nil

-- // 1. H·ªÜ TH·ªêNG "M·∫∂T BI·ªÇN B√ä T√îNG" (INVISIBLE SOLID WATER) //
-- Thay v√¨ t·∫°o part nh·ªè, ta t√¨m map n∆∞·ªõc g·ªëc v√† l√†m n√≥ c·ª©ng l·∫°i
local function EnableWaterWalk()
    pcall(function()
        -- T√¨m c√°c part n∆∞·ªõc trong Map
        for _, v in pairs(Workspace.Map:GetChildren()) do
            if v.Name:find("Water") or v.Name:find("Ocean") then
                if v:IsA("BasePart") then
                    v.CanCollide = true -- L√†m c·ª©ng l·∫°i
                    v.Size = Vector3.new(100000, 5, 100000) -- M·ªü r·ªông v√¥ t·∫≠n
                    v.Transparency = 1 -- T√†ng h√¨nh ho√†n to√†n (Kh√¥ng th·∫•y t·∫•m g√¨ c·∫£)
                end
            end
        end
    end)
end

-- H√†m tr·∫£ l·∫°i n∆∞·ªõc b√¨nh th∆∞·ªùng khi t·∫Øt script
local function DisableWaterWalk()
    pcall(function()
        for _, v in pairs(Workspace.Map:GetChildren()) do
            if v.Name:find("Water") or v.Name:find("Ocean") then
                if v:IsA("BasePart") then
                    v.CanCollide = false -- Tr·ªü l·∫°i l·ªèng
                    v.Transparency = 0 -- Hi·ªán l·∫°i m√†u n∆∞·ªõc (n·∫øu game c√≥ set)
                end
            end
        end
    end)
end

-- Ch·∫°y li√™n t·ª•c ƒë·ªÉ ƒë·∫£m b·∫£o n∆∞·ªõc lu√¥n c·ª©ng (game hay reset map)
task.spawn(function()
    while getgenv().ChestV20_Running and task.wait(2) do
        EnableWaterWalk()
    end
end)

-- // 2. H·ªÜ TH·ªêNG UNLOAD //
local function UnloadScript()
    getgenv().ChestV20_Running = false
    getgenv().Config.AutoChest = false
    
    if CurrentTween then CurrentTween:Cancel() end
    
    -- Tr·∫£ l·∫°i n∆∞·ªõc c≈©
    DisableWaterWalk()
    
    if gethui then
        if gethui():FindFirstChild("ChestV20_GUI") then gethui().ChestV20_GUI:Destroy() end
    else
        if CoreGui:FindFirstChild("ChestV20_GUI") then CoreGui.ChestV20_GUI:Destroy() end
    end
    
    -- Tr·∫£ l·∫°i v·∫≠t l√Ω
    if LocalPlayer.Character then
        for _, v in pairs(LocalPlayer.Character:GetDescendants()) do
            if v:IsA("BasePart") then v.CanCollide = true end
        end
        if LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            LocalPlayer.Character.HumanoidRootPart.Velocity = Vector3.new(0,0,0)
            LocalPlayer.Character.HumanoidRootPart.Anchored = false
        end
    end
end

UnloadScript() -- X√≥a b·∫£n c≈© n·∫øu c√≥
getgenv().ChestV20_Running = true

-- // 3. GIAO DI·ªÜN (GUI) //
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local ToggleBtn = Instance.new("TextButton")
local HopBtn = Instance.new("TextButton")
local Status = Instance.new("TextLabel")
local CloseBtn = Instance.new("TextButton")
local OpenBtn = Instance.new("ImageButton")
local UICorner = Instance.new("UICorner")

if gethui then ScreenGui.Parent = gethui() else ScreenGui.Parent = CoreGui end
ScreenGui.Name = "ChestV20_GUI"

-- Icon M·ªü
OpenBtn.Parent = ScreenGui
OpenBtn.Position = UDim2.new(0, 20, 0.4, 0)
OpenBtn.Size = UDim2.new(0, 50, 0, 50)
OpenBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
OpenBtn.Image = "rbxassetid://9267242786"
OpenBtn.Active = true
OpenBtn.Draggable = true
Instance.new("UICorner", OpenBtn).CornerRadius = UDim.new(1, 0)
Instance.new("UIStroke", OpenBtn).Color = Color3.fromRGB(0, 255, 255)

-- Menu
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(10, 20, 30)
MainFrame.Position = UDim2.new(0.2, 0, 0.2, 0)
MainFrame.Size = UDim2.new(0, 250, 0, 180)
MainFrame.Visible = false
MainFrame.Active = true
MainFrame.Draggable = true
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)
Instance.new("UIStroke", MainFrame).Color = Color3.fromRGB(0, 150, 255)

Title.Parent = MainFrame
Title.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
Title.Size = UDim2.new(1, 0, 0, 30)
Title.Text = "  POSEIDON V20 (SOLID WATER)"
Title.TextColor3 = Color3.new(1,1,1)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 14
Title.TextXAlignment = Enum.TextXAlignment.Left
Instance.new("UICorner", Title).CornerRadius = UDim.new(0, 8)

CloseBtn.Parent = MainFrame
CloseBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
CloseBtn.Position = UDim2.new(1, -30, 0, 0)
CloseBtn.Size = UDim2.new(0, 30, 0, 30)
CloseBtn.Text = "X"
CloseBtn.TextColor3 = Color3.new(1,1,1)
CloseBtn.Font = Enum.Font.SourceSansBold
Instance.new("UICorner", CloseBtn).CornerRadius = UDim.new(0, 8)

ToggleBtn.Parent = MainFrame
ToggleBtn.Position = UDim2.new(0.1, 0, 0.25, 0)
ToggleBtn.Size = UDim2.new(0.8, 0, 0.25, 0)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
ToggleBtn.Text = "üî¥ FARM: T·∫ÆT"
ToggleBtn.Font = Enum.Font.SourceSansBold
ToggleBtn.TextSize = 16
ToggleBtn.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(0, 6)

HopBtn.Parent = MainFrame
HopBtn.Position = UDim2.new(0.1, 0, 0.55, 0)
HopBtn.Size = UDim2.new(0.8, 0, 0.2, 0)
HopBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
HopBtn.Text = "üü¢ AUTO HOP: B·∫¨T"
HopBtn.Font = Enum.Font.SourceSansBold
HopBtn.TextSize = 14
HopBtn.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", HopBtn).CornerRadius = UDim.new(0, 6)

Status.Parent = MainFrame
Status.BackgroundTransparency = 1
Status.Position = UDim2.new(0, 10, 0.8, 0)
Status.Size = UDim2.new(1, -20, 0.2, 0)
Status.TextColor3 = Color3.new(1,1,0)
Status.Text = "M·∫∑t n∆∞·ªõc ƒë√£ c·ª©ng..."
Status.TextSize = 12
Status.Font = Enum.Font.Code

OpenBtn.MouseButton1Click:Connect(function() MainFrame.Visible = not MainFrame.Visible end)
CloseBtn.MouseButton1Click:Connect(function() UnloadScript() end)

-- // 4. LOGIC CH√çNH //
local function HopServer()
    Status.Text = "‚è≥ T√¨m Server m·ªõi..."
    local PlaceID = game.PlaceId
    local AllIDs = {}
    local function TPReturner()
        local Site;
        if foundAnything == "" then
            Site = HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100'))
        else
            Site = HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100&cursor=' .. foundAnything))
        end
        if Site.nextPageCursor and Site.nextPageCursor ~= "null" and Site.nextPageCursor ~= nil then
            foundAnything = Site.nextPageCursor
        end
        for i,v in pairs(Site.data) do
            if v.playing < v.maxPlayers and v.id ~= game.JobId then
                table.insert(AllIDs, v.id)
            end
        end
    end
    pcall(function()
        TPReturner()
        if #AllIDs > 0 then
            TeleportService:TeleportToPlaceInstance(PlaceID, AllIDs[math.random(1, #AllIDs)], LocalPlayer)
        end
    end)
end

local function Tween(targetCFrame)
    if not LocalPlayer.Character then return end
    local HRP = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not HRP then return end

    local Distance = (HRP.Position - targetCFrame.Position).Magnitude
    local Time = Distance / getgenv().Config.Speed
    local Info = TweenInfo.new(Time, Enum.EasingStyle.Linear)
    
    if CurrentTween then CurrentTween:Cancel() end
    CurrentTween = TweenService:Create(HRP, Info, {CFrame = targetCFrame})
    CurrentTween:Play()
    
    local NoclipLoop = RunService.Stepped:Connect(function()
        if not getgenv().ChestV20_Running then return end
        if LocalPlayer.Character then
            for _, v in pairs(LocalPlayer.Character:GetDescendants()) do
                if v:IsA("BasePart") then v.CanCollide = false end
            end
        end
    end)

    CurrentTween.Completed:Wait()
    NoclipLoop:Disconnect()
end

task.spawn(function()
    while task.wait() and getgenv().ChestV20_Running do
        if getgenv().Config.AutoChest then
            pcall(function()
                -- A. T√åM TR√ÅI C√ÇY
                local Fruit = nil
                for _, v in pairs(Workspace:GetChildren()) do
                    if (string.find(v.Name, "Fruit") or string.find(v.Name, "Model")) and v:FindFirstChild("Handle") then
                        Fruit = v
                        break
                    end
                end

                if Fruit and getgenv().Config.AutoFruit then
                    Status.Text = "üî• NH·∫∂T: " .. Fruit.Name
                    Tween(Fruit.Handle.CFrame)
                    -- Store Fruit
                    game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("StoreFruit", "Blox Fruit", Fruit)
                else
                    -- B. T√åM R∆Ø∆†NG
                    local Chest = nil
                    local MinDist = math.huge
                    local HRP = LocalPlayer.Character.HumanoidRootPart
                    
                    for _, v in pairs(Workspace:GetDescendants()) do
                        if v.Name:find("Chest") and v:IsA("Part") and v:FindFirstChild("TouchInterest") and v.Transparency < 0.8 then
                            local d = (v.Position - HRP.Position).Magnitude
                            if d < MinDist then
                                MinDist = d
                                Chest = v
                            end
                        end
                    end

                    if Chest then
                        Status.Text = "üí∞ Nh·∫∑t: " .. Chest.Name
                        Tween(Chest.CFrame)
                    else
                        Status.Text = "H·∫øt r∆∞∆°ng! Hop..."
                        if getgenv().Config.AutoHop then
                            HopServer()
                            task.wait(5)
                        end
                    end
                end
            end)
        else
            if CurrentTween then CurrentTween:Cancel() end
            Status.Text = "ƒê√£ d·ª´ng."
        end
    end
end)

-- X·ª≠ l√Ω n√∫t
ToggleBtn.MouseButton1Click:Connect(function()
    getgenv().Config.AutoChest = not getgenv().Config.AutoChest
    if getgenv().Config.AutoChest then
        ToggleBtn.Text = "üü¢ CH·∫†Y: ON"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
    else
        ToggleBtn.Text = "üî¥ D·ª™NG: OFF"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    end
end)

HopBtn.MouseButton1Click:Connect(function()
    getgenv().Config.AutoHop = not getgenv().Config.AutoHop
    if getgenv().Config.AutoHop then
        HopBtn.Text = "üü¢ HOP: B·∫¨T"
        HopBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
    else
        HopBtn.Text = "üî¥ HOP: T·∫ÆT"
        HopBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    end
end)

VirtualUser:CaptureController()
LocalPlayer.Idled:Connect(function() VirtualUser:ClickButton2(Vector2.new()) end)
