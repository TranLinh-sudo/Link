--[[
    üíé AUTO CHEST V17 - FULL CONTROL
    Ch·ª©c nƒÉng: Farm R∆∞∆°ng + Nh·∫∑t Tr√°i + N√∫t Auto Hop ri√™ng bi·ªát + N√∫t X√≥a Script
]]

getgenv().ChestV17_Running = true

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")

local LocalPlayer = Players.LocalPlayer
local CommF = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("CommF_")

-- // C·∫§U H√åNH //
getgenv().Config = {
    AutoChest = false,       
    AutoHop = true,          -- M·∫∑c ƒë·ªãnh b·∫≠t
    AutoFruit = true,
    Speed = 300,
    HopDelay = 2
}

local CurrentTween = nil

-- // 1. H·ªÜ TH·ªêNG UNLOAD //
local function UnloadScript()
    getgenv().ChestV17_Running = false
    getgenv().Config.AutoChest = false
    if CurrentTween then CurrentTween:Cancel() end
    
    if gethui then
        if gethui():FindFirstChild("ChestV17_GUI") then gethui().ChestV17_GUI:Destroy() end
    else
        if CoreGui:FindFirstChild("ChestV17_GUI") then CoreGui.ChestV17_GUI:Destroy() end
    end
    
    if LocalPlayer.Character then
        for _, v in pairs(LocalPlayer.Character:GetDescendants()) do
            if v:IsA("BasePart") then v.CanCollide = true end
        end
        if LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            LocalPlayer.Character.HumanoidRootPart.Velocity = Vector3.new(0,0,0)
            LocalPlayer.Character.HumanoidRootPart.Anchored = false
        end
    end
    
    pcall(function()
        if Workspace.Map:FindFirstChild("WaterBase-Plane") then
            Workspace.Map["WaterBase-Plane"].CanCollide = false
        end
    end)
end

-- // 2. GIAO DI·ªÜN (GUI) //
UnloadScript() -- X√≥a b·∫£n c≈©
getgenv().ChestV17_Running = true

local ScreenGui = Instance.new("ScreenGui")
local OpenBtn = Instance.new("ImageButton")
local MainFrame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local ToggleBtn = Instance.new("TextButton")
local HopBtn = Instance.new("TextButton") -- N√öT HOP M·ªöI
local UnloadBtn = Instance.new("TextButton")
local Status = Instance.new("TextLabel")
local UICorner = Instance.new("UICorner")

if gethui then ScreenGui.Parent = gethui() else ScreenGui.Parent = CoreGui end
ScreenGui.Name = "ChestV17_GUI"

-- Icon
OpenBtn.Parent = ScreenGui
OpenBtn.Position = UDim2.new(0, 20, 0.4, 0)
OpenBtn.Size = UDim2.new(0, 50, 0, 50)
OpenBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
OpenBtn.Image = "rbxassetid://9267242786"
OpenBtn.Active = true
OpenBtn.Draggable = true
Instance.new("UICorner", OpenBtn).CornerRadius = UDim.new(1, 0)
Instance.new("UIStroke", OpenBtn).Color = Color3.fromRGB(255, 255, 0)

-- Menu
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
MainFrame.Position = UDim2.new(0.2, 0, 0.2, 0)
MainFrame.Size = UDim2.new(0, 260, 0, 250) -- Cao h∆°n ƒë·ªÉ ch·ª©a th√™m n√∫t
MainFrame.Visible = false
MainFrame.Active = true
MainFrame.Draggable = true
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)
Instance.new("UIStroke", MainFrame).Color = Color3.fromRGB(0, 255, 255)

Title.Parent = MainFrame
Title.BackgroundColor3 = Color3.fromRGB(0, 150, 200)
Title.Size = UDim2.new(1, 0, 0, 30)
Title.Text = "AUTO CHEST V17"
Title.TextColor3 = Color3.new(1,1,1)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 16
Instance.new("UICorner", Title).CornerRadius = UDim.new(0, 10)

-- N√∫t Farm
ToggleBtn.Parent = MainFrame
ToggleBtn.Position = UDim2.new(0.1, 0, 0.18, 0)
ToggleBtn.Size = UDim2.new(0.8, 0, 0.18, 0)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
ToggleBtn.Text = "üî¥ FARM: T·∫ÆT"
ToggleBtn.Font = Enum.Font.SourceSansBold
ToggleBtn.TextSize = 16
ToggleBtn.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(0, 6)

-- N√∫t Hop (M·ªöI)
HopBtn.Parent = MainFrame
HopBtn.Position = UDim2.new(0.1, 0, 0.40, 0)
HopBtn.Size = UDim2.new(0.8, 0, 0.18, 0)
HopBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100) -- M·∫∑c ƒë·ªãnh l√† B·∫≠t
HopBtn.Text = "üü¢ HOP: B·∫¨T"
HopBtn.Font = Enum.Font.SourceSansBold
HopBtn.TextSize = 16
HopBtn.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", HopBtn).CornerRadius = UDim.new(0, 6)

-- N√∫t X√≥a
UnloadBtn.Parent = MainFrame
UnloadBtn.Position = UDim2.new(0.1, 0, 0.62, 0)
UnloadBtn.Size = UDim2.new(0.8, 0, 0.15, 0)
UnloadBtn.BackgroundColor3 = Color3.fromRGB(100, 0, 0)
UnloadBtn.Text = "üóëÔ∏è X√ìA SCRIPT"
UnloadBtn.Font = Enum.Font.SourceSansBold
UnloadBtn.TextSize = 14
UnloadBtn.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", UnloadBtn).CornerRadius = UDim.new(0, 6)

Status.Parent = MainFrame
Status.BackgroundTransparency = 1
Status.Position = UDim2.new(0, 10, 0.8, 0)
Status.Size = UDim2.new(1, -20, 0.2, 0)
Status.TextColor3 = Color3.new(1,1,0)
Status.Text = "S·∫µn s√†ng..."
Status.TextWrapped = true
Status.TextSize = 12
Status.Font = Enum.Font.Code

-- Event Menu
OpenBtn.MouseButton1Click:Connect(function() MainFrame.Visible = not MainFrame.Visible end)
UnloadBtn.MouseButton1Click:Connect(function() UnloadScript() end)

-- // 3. LOGIC //
task.spawn(function()
    while getgenv().ChestV17_Running and task.wait(1) do
        pcall(function()
            local WaterBase = Workspace.Map:FindFirstChild("WaterBase-Plane")
            if WaterBase then
                WaterBase.Size = Vector3.new(100000, 112, 100000)
                WaterBase.CanCollide = true
                WaterBase.Transparency = 0.5
            end
        end)
    end
end)

local function ForceTouch(target)
    if not target then return end
    if firetouchinterest then
        firetouchinterest(LocalPlayer.Character.HumanoidRootPart, target, 0)
        task.wait(0.01)
        firetouchinterest(LocalPlayer.Character.HumanoidRootPart, target, 1)
    else
        LocalPlayer.Character.HumanoidRootPart.CFrame = target.CFrame
    end
end

local function Tween(targetCFrame)
    if not LocalPlayer.Character then return end
    local HRP = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    local Distance = (HRP.Position - targetCFrame.Position).Magnitude
    local Time = Distance / getgenv().Config.Speed
    local Info = TweenInfo.new(Time, Enum.EasingStyle.Linear)
    
    if CurrentTween then CurrentTween:Cancel() end
    CurrentTween = TweenService:Create(HRP, Info, {CFrame = targetCFrame})
    CurrentTween:Play()
    
    local Completed = false
    local Con = CurrentTween.Completed:Connect(function() Completed = true; Con:Disconnect() end)
    
    local NoclipLoop = RunService.Stepped:Connect(function()
        if not getgenv().ChestV17_Running then return end
        if LocalPlayer.Character then
            for _, v in pairs(LocalPlayer.Character:GetDescendants()) do
                if v:IsA("BasePart") then v.CanCollide = false end
            end
        end
        if (HRP.Position - targetCFrame.Position).Magnitude < 5 then
            if CurrentTween then CurrentTween:Cancel() end
            Completed = true
        end
    end)
    
    while not Completed and getgenv().Config.AutoChest and getgenv().ChestV17_Running do task.wait() end
    if NoclipLoop then NoclipLoop:Disconnect() end
end

local function GetFruit()
    for _, v in pairs(Workspace:GetChildren()) do
        if (string.find(v.Name, "Fruit") or v:IsA("Tool")) and v:FindFirstChild("Handle") then
            return v
        end
    end
    return nil
end

local function GetChest()
    local HRP = LocalPlayer.Character.HumanoidRootPart
    local nearest, minDist = nil, math.huge
    for _, v in pairs(Workspace:GetDescendants()) do
        if v.Name:find("Chest") and v:IsA("Part") and v:FindFirstChild("TouchInterest") and v.Transparency < 0.8 then
            local dist = (v.Position - HRP.Position).Magnitude
            if dist < minDist then minDist = dist; nearest = v end
        end
    end
    return nearest
end

local function HopServer()
    Status.Text = "‚è≥ ƒê·ªïi Server..."
    local PlaceID = game.PlaceId
    local AllIDs = {}
    local foundAnything = ""
    local function TPReturner()
        local Site;
        if foundAnything == "" then
            Site = HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100'))
        else
            Site = HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100&cursor=' .. foundAnything))
        end
        if Site.nextPageCursor and Site.nextPageCursor ~= "null" and Site.nextPageCursor ~= nil then
            foundAnything = Site.nextPageCursor
        end
        for i,v in pairs(Site.data) do
            if v.playing < v.maxPlayers and v.id ~= game.JobId then
                table.insert(AllIDs, v.id)
            end
        end
    end
    pcall(function()
        TPReturner()
        if #AllIDs > 0 then
            TeleportService:TeleportToPlaceInstance(PlaceID, AllIDs[math.random(1, #AllIDs)], LocalPlayer)
        end
    end)
end

-- MAIN LOOP
task.spawn(function()
    while task.wait() and getgenv().ChestV17_Running do
        if getgenv().Config.AutoChest then
            pcall(function()
                -- 1. Nh·∫∑t tr√°i
                local Fruit = GetFruit()
                if Fruit and getgenv().Config.AutoFruit then
                    Status.Text = "üî• FRUIT: " .. Fruit.Name
                    Status.TextColor3 = Color3.fromRGB(255, 0, 0)
                    Tween(Fruit.Handle.CFrame)
                    ForceTouch(Fruit.Handle)
                    task.wait(0.5)
                    CommF:InvokeServer("StoreFruit", "Blox Fruit", Fruit)
                else
                    -- 2. Nh·∫∑t R∆∞∆°ng
                    local Chest = GetChest()
                    if Chest then
                        Status.Text = "üí∞ Chest: " .. Chest.Name
                        Status.TextColor3 = Color3.new(1,1,1)
                        Tween(Chest.CFrame)
                        ForceTouch(Chest)
                    else
                        -- 3. ƒê·ªïi Server (N·∫øu n√∫t Hop ƒëang B·∫¨T)
                        if getgenv().Config.AutoHop then
                            Status.Text = "H·∫øt r∆∞∆°ng! Hop..."
                            HopServer()
                            task.wait(5)
                        else
                            Status.Text = "H·∫øt r∆∞∆°ng! (ƒêang ƒë·ª£i spawn...)"
                            Status.TextColor3 = Color3.fromRGB(255, 255, 0)
                        end
                    end
                end
            end)
        else
            if CurrentTween then CurrentTween:Cancel() end
            Status.Text = "ƒêang d·ª´ng."
        end
    end
end)

-- X·ª¨ L√ù N√öT B·∫§M
ToggleBtn.MouseButton1Click:Connect(function()
    getgenv().Config.AutoChest = not getgenv().Config.AutoChest
    if getgenv().Config.AutoChest then
        ToggleBtn.Text = "üü¢ FARM: B·∫¨T"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
    else
        ToggleBtn.Text = "üî¥ FARM: T·∫ÆT"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    end
end)

HopBtn.MouseButton1Click:Connect(function()
    getgenv().Config.AutoHop = not getgenv().Config.AutoHop
    if getgenv().Config.AutoHop then
        HopBtn.Text = "üü¢ HOP: B·∫¨T"
        HopBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
    else
        HopBtn.Text = "üî¥ HOP: T·∫ÆT"
        HopBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    end
end)

-- Anti AFK
VirtualUser:CaptureController()
LocalPlayer.Idled:Connect(function() VirtualUser:ClickButton2(Vector2.new()) end)
