--[[
    üíé AUTO CHEST V3 - GLOBAL FARM (SEA 3 OPTIMIZED)
    Ch·ª©c nƒÉng: Bay m∆∞·ª£t, Xuy√™n t∆∞·ªùng, T·ª± ƒë·ªïi ƒë·∫£o, Gi·ªØ ƒë·ªô cao m·∫∑t n∆∞·ªõc
]]

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer
local CommF = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("CommF_")

-- // C·∫§U H√åNH //
getgenv().Config = {
    AutoChest = false,       -- B·∫≠t/T·∫Øt
    Speed = 300,             -- T·ªëc ƒë·ªô bay (300 l√† an to√†n)
    WaterHeight = 20,        -- ƒê·ªô cao c√°ch m·∫∑t n∆∞·ªõc (Y)
    HopDelay = 2             -- Th·ªùi gian ƒë·ª£i load ƒë·∫£o m·ªõi
}

-- Danh s√°ch c√°c ƒëi·ªÉm D·ªãch chuy·ªÉn (Sea 3 - World 3)
-- Script s·∫Ω bay qua c√°c ƒëi·ªÉm n√†y ƒë·ªÉ load r∆∞∆°ng m·ªõi
local IslandList = {
    {Name = "Castle on the Sea", Pos = Vector3.new(-5074, 314, -3151)},
    {Name = "Hydra Island", Pos = Vector3.new(5756, 610, -283)},
    {Name = "Floating Turtle", Pos = Vector3.new(-12463, 375, -7552)},
    {Name = "Haunted Castle", Pos = Vector3.new(-9548, 142, 5536)},
    {Name = "Port Town", Pos = Vector3.new(-265, 9, 5335)},
    {Name = "Great Tree", Pos = Vector3.new(2356, 30, -6940)},
    {Name = "Candy Island", Pos = Vector3.new(-1111, 15, -14344)}
}

local CurrentIslandIndex = 1
local CurrentTween = nil

-- // 1. GIAO DI·ªÜN ƒêI·ªÄU KHI·ªÇN //
local ScreenGui = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local ToggleBtn = Instance.new("TextButton")
local Status = Instance.new("TextLabel")

if gethui then ScreenGui.Parent = gethui() else ScreenGui.Parent = CoreGui end
ScreenGui.Name = "ChestV3"

Frame.Parent = ScreenGui
Frame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
Frame.Position = UDim2.new(0.1, 0, 0.2, 0)
Frame.Size = UDim2.new(0, 250, 0, 160)
Frame.Active = true
Frame.Draggable = true
Frame.BorderSizePixel = 2
Frame.BorderColor3 = Color3.fromRGB(0, 255, 255)

Title.Parent = Frame
Title.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
Title.Size = UDim2.new(1, 0, 0, 35)
Title.Text = "AUTO CHEST V3 (GLOBAL)"
Title.TextColor3 = Color3.new(1,1,1)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 16

ToggleBtn.Parent = Frame
ToggleBtn.Position = UDim2.new(0.1, 0, 0.3, 0)
ToggleBtn.Size = UDim2.new(0.8, 0, 0.3, 0)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
ToggleBtn.Text = "üî¥ T·∫ÆT (OFF)"
ToggleBtn.Font = Enum.Font.SourceSansBold
ToggleBtn.TextSize = 18
ToggleBtn.TextColor3 = Color3.new(1,1,1)

Status.Parent = Frame
Status.BackgroundTransparency = 1
Status.Position = UDim2.new(0, 10, 0.65, 0)
Status.Size = UDim2.new(1, -20, 0.3, 0)
Status.TextColor3 = Color3.new(1,1,0)
Status.Text = "Tr·∫°ng th√°i: ƒêang ngh·ªâ"
Status.TextWrapped = true
Status.Font = Enum.Font.Code
Status.TextSize = 14

-- // 2. H√ÄM NOCLIP (XUY√äN T∆Ø·ªúNG) //
RunService.Stepped:Connect(function()
    if getgenv().Config.AutoChest and LocalPlayer.Character then
        for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
            if part:IsA("BasePart") then part.CanCollide = false end
        end
        
        -- Gi·ªØ nh√¢n v·∫≠t kh√¥ng b·ªã r∆°i
        if LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            LocalPlayer.Character.HumanoidRootPart.Velocity = Vector3.new(0,0,0)
        end
    end
end)

-- // 3. H√ÄM BAY (TWEEN) //
local function Tween(targetPos)
    if not LocalPlayer.Character then return end
    local HRP = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not HRP then return end

    local Distance = (HRP.Position - targetPos).Magnitude
    local Time = Distance / getgenv().Config.Speed
    
    local Info = TweenInfo.new(Time, Enum.EasingStyle.Linear)
    
    if CurrentTween then CurrentTween:Cancel() end
    CurrentTween = TweenService:Create(HRP, Info, {CFrame = CFrame.new(targetPos)})
    CurrentTween:Play()
    
    -- Ch·ªù bay xong ho·∫∑c b·ªã h·ªßy
    local Completed = false
    local Con
    Con = CurrentTween.Completed:Connect(function()
        Completed = true
        Con:Disconnect()
    end)
    
    -- V√≤ng l·∫∑p ch·ªù (Break n·∫øu t·∫Øt tool)
    while not Completed and getgenv().Config.AutoChest do
        task.wait()
    end
end

-- // 4. LOGIC CH√çNH //
local function GetNearestChest()
    local HRP = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not HRP then return nil end
    
    local nearest = nil
    local minDist = math.huge
    
    for _, v in pairs(Workspace:GetDescendants()) do
        if v.Name:find("Chest") and v:IsA("Part") and v:FindFirstChild("TouchInterest") then
            -- Ki·ªÉm tra xem r∆∞∆°ng ƒë√£ m·ªü ch∆∞a (Transparency = 0 l√† ch∆∞a m·ªü)
            if v.Transparency < 1 then
                local dist = (v.Position - HRP.Position).Magnitude
                if dist < minDist then
                    minDist = dist
                    nearest = v
                end
            end
        end
    end
    return nearest
end

-- H√†m ƒë·ªïi ƒë·∫£o (Khi h·∫øt r∆∞∆°ng)
local function HopToNextIsland()
    CurrentIslandIndex = CurrentIslandIndex + 1
    if CurrentIslandIndex > #IslandList then CurrentIslandIndex = 1 end
    
    local NextIsland = IslandList[CurrentIslandIndex]
    Status.Text = "ƒêang ƒë·∫øn ƒë·∫£o: " .. NextIsland.Name
    
    -- 1. Th·ª≠ d√πng C·ªïng D·ªãch Chuy·ªÉn (Nhanh nh·∫•t)
    local args = {
        [1] = "requestEntrance",
        [2] = NextIsland.Pos
    }
    
    pcall(function()
        CommF:InvokeServer(unpack(args))
    end)
    
    task.wait(0.5)
    
    -- 2. N·∫øu c·ªïng kh√¥ng ho·∫°t ƒë·ªông -> Bay th∆∞·ªùng
    local HRP = LocalPlayer.Character.HumanoidRootPart
    if (HRP.Position - NextIsland.Pos).Magnitude > 1000 then
        -- Bay cao l√™n tr·ªùi tr∆∞·ªõc khi sang ƒë·∫£o kh√°c
        Tween(Vector3.new(HRP.Position.X, 300, HRP.Position.Z)) 
        Tween(Vector3.new(NextIsland.Pos.X, 300, NextIsland.Pos.Z))
    end
end

-- V√≤ng l·∫∑p x·ª≠ l√Ω
task.spawn(function()
    while task.wait() do
        if getgenv().Config.AutoChest then
            pcall(function()
                local Chest = GetNearestChest()
                
                if Chest then
                    Status.Text = "Nh·∫∑t: " .. Chest.Name
                    
                    -- Logic bay th√¥ng minh:
                    -- Bay th·∫≥ng ƒë·∫øn v·ªã tr√≠ r∆∞∆°ng (CFrame g·ªëc)
                    -- Nh∆∞ng gi·ªØ ƒë·ªô cao 1 ch√∫t ƒë·ªÉ kh√¥ng b·ªã chui xu·ªëng ƒë·∫•t
                    
                    if (LocalPlayer.Character.HumanoidRootPart.Position - Chest.Position).Magnitude > 50 then
                        -- N·∫øu ·ªü xa: Bay cao h∆°n m·∫∑t n∆∞·ªõc
                        local FlyPos = Vector3.new(Chest.Position.X, math.max(Chest.Position.Y, getgenv().Config.WaterHeight), Chest.Position.Z)
                        Tween(FlyPos)
                    else
                        -- N·∫øu ·ªü g·∫ßn: Lao th·∫≥ng v√†o
                        Tween(Chest.Position)
                    end
                else
                    -- H·∫øt r∆∞∆°ng -> ƒê·ªïi ƒë·∫£o
                    Status.Text = "ƒê·∫£o n√†y h·∫øt r∆∞∆°ng! ƒêang ƒë·ªïi..."
                    HopToNextIsland()
                    task.wait(getgenv().Config.HopDelay)
                end
            end)
        else
            if CurrentTween then CurrentTween:Cancel() end
            Status.Text = "Tr·∫°ng th√°i: ƒê√£ d·ª´ng"
        end
    end
end)

-- // X·ª¨ L√ù N√öT B·∫§M //
ToggleBtn.MouseButton1Click:Connect(function()
    getgenv().Config.AutoChest = not getgenv().Config.AutoChest
    if getgenv().Config.AutoChest then
        ToggleBtn.Text = "üü¢ B·∫¨T (ON)"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
    else
        ToggleBtn.Text = "üî¥ T·∫ÆT (OFF)"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    end
end)
