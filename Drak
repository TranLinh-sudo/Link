--[[ 
    SCRIPT EXPLORER V7 - ULTIMATE EDITION
    Full Option: Thanh Tiến Độ + Tìm Kiếm + Xem Code
]]

-- 1. HÀM TẠO CỬA SỔ XEM CODE (VIEWER)
local function ShowCodeWindow(title, content)
    local ScreenGui = Instance.new("ScreenGui")
    local MainFrame = Instance.new("Frame")
    local TopBar = Instance.new("Frame")
    local TitleLbl = Instance.new("TextLabel")
    local CloseBtn = Instance.new("TextButton")
    local CopyBtn = Instance.new("TextButton")
    local Scroll = Instance.new("ScrollingFrame")
    local CodeBox = Instance.new("TextBox")

    if gethui then ScreenGui.Parent = gethui() else ScreenGui.Parent = game.CoreGui end
    ScreenGui.Name = "CodeViewer"

    -- Khung chính
    MainFrame.Parent = ScreenGui
    MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    MainFrame.Position = UDim2.new(0.2, 0, 0.1, 0)
    MainFrame.Size = UDim2.new(0.7, 0, 0.8, 0)
    MainFrame.BorderSizePixel = 2
    MainFrame.BorderColor3 = Color3.fromRGB(0, 255, 0)
    MainFrame.Active = true
    MainFrame.Draggable = true

    -- Thanh tiêu đề
    TopBar.Parent = MainFrame
    TopBar.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
    TopBar.Size = UDim2.new(1, 0, 0, 35)

    TitleLbl.Parent = TopBar
    TitleLbl.BackgroundTransparency = 1
    TitleLbl.Position = UDim2.new(0, 10, 0, 0)
    TitleLbl.Size = UDim2.new(0.6, 0, 1, 0)
    TitleLbl.Font = Enum.Font.SourceSansBold
    TitleLbl.Text = "SOURCE: " .. title
    TitleLbl.TextColor3 = Color3.new(0,0,0)
    TitleLbl.TextSize = 16
    TitleLbl.TextXAlignment = Enum.TextXAlignment.Left

    CloseBtn.Parent = TopBar
    CloseBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    CloseBtn.Position = UDim2.new(1, -40, 0, 0)
    CloseBtn.Size = UDim2.new(0, 40, 0, 35)
    CloseBtn.Text = "X"
    CloseBtn.TextSize = 18
    CloseBtn.MouseButton1Click:Connect(function() ScreenGui:Destroy() end)

    CopyBtn.Parent = TopBar
    CopyBtn.BackgroundColor3 = Color3.fromRGB(0, 100, 255)
    CopyBtn.Position = UDim2.new(1, -150, 0, 0)
    CopyBtn.Size = UDim2.new(0, 100, 0, 35)
    CopyBtn.Text = "COPY ALL"
    CopyBtn.Font = Enum.Font.SourceSansBold
    CopyBtn.TextSize = 14
    CopyBtn.TextColor3 = Color3.new(1,1,1)
    CopyBtn.MouseButton1Click:Connect(function()
        setclipboard(content)
        CopyBtn.Text = "COPIED!"
        wait(1)
        CopyBtn.Text = "COPY ALL"
    end)

    Scroll.Parent = MainFrame
    Scroll.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    Scroll.Position = UDim2.new(0, 10, 0, 45)
    Scroll.Size = UDim2.new(1, -20, 1, -55)
    Scroll.CanvasSize = UDim2.new(0, 0, 10, 0)
    Scroll.ScrollBarThickness = 6

    CodeBox.Parent = Scroll
    CodeBox.Size = UDim2.new(1, 0, 1, 0)
    CodeBox.BackgroundTransparency = 1
    CodeBox.TextColor3 = Color3.fromRGB(200, 200, 200)
    CodeBox.Font = Enum.Font.Code
    CodeBox.TextSize = 13
    CodeBox.TextXAlignment = Enum.TextXAlignment.Left
    CodeBox.TextYAlignment = Enum.TextYAlignment.Top
    CodeBox.Text = content
    CodeBox.ClearTextOnFocus = false
    CodeBox.TextEditable = false
    CodeBox.MultiLine = true
    
    local _, lines = string.gsub(content, "\n", "")
    Scroll.CanvasSize = UDim2.new(0, 0, 0, lines * 15 + 500)
end

-- 2. GIAO DIỆN CHÍNH (EXPLORER V7)
local function CreateExplorer()
    local ScreenGui = Instance.new("ScreenGui")
    local Frame = Instance.new("Frame")
    local Title = Instance.new("TextLabel")
    
    -- Phần Thanh Tiến Độ (Status Bar)
    local BarContainer = Instance.new("Frame")
    local BarFill = Instance.new("Frame")
    local PercentText = Instance.new("TextLabel")
    local StatusText = Instance.new("TextLabel")
    
    -- Phần Danh Sách & Tìm Kiếm
    local SearchBar = Instance.new("TextBox")
    local Scroll = Instance.new("ScrollingFrame")
    local UIList = Instance.new("UIListLayout")
    local CloseBtn = Instance.new("TextButton")
    
    if gethui then ScreenGui.Parent = gethui() else ScreenGui.Parent = game.CoreGui end
    ScreenGui.Name = "ExplorerV7"

    -- Khung
    Frame.Parent = ScreenGui
    Frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    Frame.Position = UDim2.new(0.02, 0, 0.15, 0)
    Frame.Size = UDim2.new(0, 280, 0, 450)
    Frame.BorderSizePixel = 2
    Frame.BorderColor3 = Color3.fromRGB(255, 170, 0)
    Frame.Active = true
    Frame.Draggable = true

    -- Tiêu đề
    Title.Parent = Frame
    Title.BackgroundColor3 = Color3.fromRGB(255, 150, 0)
    Title.Size = UDim2.new(1, 0, 0, 35)
    Title.Text = "  QUÉT SCRIPT (V7)"
    Title.TextColor3 = Color3.new(1,1,1)
    Title.TextSize = 16
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.Font = Enum.Font.SourceSansBold

    CloseBtn.Parent = Frame
    CloseBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    CloseBtn.Position = UDim2.new(1, -35, 0, 0)
    CloseBtn.Size = UDim2.new(0, 35, 0, 35)
    CloseBtn.Text = "X"
    CloseBtn.MouseButton1Click:Connect(function() ScreenGui:Destroy() end)

    -- ==== THANH TIẾN ĐỘ ====
    BarContainer.Parent = Frame
    BarContainer.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    BarContainer.Position = UDim2.new(0, 10, 0, 45)
    BarContainer.Size = UDim2.new(1, -20, 0, 20)
    BarContainer.BorderSizePixel = 0

    BarFill.Parent = BarContainer
    BarFill.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
    BarFill.Size = UDim2.new(0, 0, 1, 0)
    BarFill.BorderSizePixel = 0

    PercentText.Parent = BarContainer
    PercentText.BackgroundTransparency = 1
    PercentText.Size = UDim2.new(1, 0, 1, 0)
    PercentText.Text = "0%"
    PercentText.TextColor3 = Color3.new(1,1,1)
    PercentText.TextSize = 12
    PercentText.ZIndex = 2
    PercentText.Font = Enum.Font.SourceSansBold

    StatusText.Parent = Frame
    StatusText.BackgroundTransparency = 1
    StatusText.Position = UDim2.new(0, 10, 0, 70)
    StatusText.Size = UDim2.new(1, -20, 0, 15)
    StatusText.Text = "Đang chuẩn bị..."
    StatusText.TextColor3 = Color3.fromRGB(200, 200, 200)
    StatusText.TextSize = 12
    StatusText.TextXAlignment = Enum.TextXAlignment.Left
    StatusText.Font = Enum.Font.Code

    -- ==== KHU VỰC DANH SÁCH (Ẩn lúc đầu) ====
    SearchBar.Parent = Frame
    SearchBar.Visible = false
    SearchBar.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    SearchBar.Position = UDim2.new(0, 10, 0, 90)
    SearchBar.Size = UDim2.new(1, -20, 0, 30)
    SearchBar.PlaceholderText = "Gõ tên script để tìm..."
    SearchBar.Text = ""
    SearchBar.TextSize = 14
    SearchBar.Font = Enum.Font.SourceSans

    Scroll.Parent = Frame
    Scroll.Visible = false
    Scroll.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    Scroll.Position = UDim2.new(0, 10, 0, 130)
    Scroll.Size = UDim2.new(1, -20, 1, -140)
    Scroll.CanvasSize = UDim2.new(0, 0, 0, 0)
    
    UIList.Parent = Scroll
    UIList.SortOrder = Enum.SortOrder.LayoutOrder
    
    return {
        Frame = Frame, BarFill = BarFill, Percent = PercentText, 
        Status = StatusText, Search = SearchBar, Scroll = Scroll
    }
end

-- 3. LOGIC CHÍNH
local UI = CreateExplorer()
local AllScripts = {}

local function RenderList(filter)
    for _, v in pairs(UI.Scroll:GetChildren()) do
        if v:IsA("TextButton") then v:Destroy() end
    end
    
    local count = 0
    for _, v in ipairs(AllScripts) do
        if filter == "" or string.find(string.lower(v.Name), string.lower(filter)) then
            count = count + 1
            local btn = Instance.new("TextButton")
            btn.Parent = UI.Scroll
            btn.Size = UDim2.new(1, 0, 0, 40)
            btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
            btn.Text = "  " .. v.Name
            btn.TextColor3 = Color3.fromRGB(200, 200, 200)
            btn.TextXAlignment = Enum.TextXAlignment.Left
            btn.Font = Enum.Font.Code
            btn.TextSize = 13
            
            btn.MouseButton1Click:Connect(function()
                btn.Text = "⏳ Đang đọc..."
                spawn(function()
                    local s, code = pcall(function() return decompile(v) end)
                    if s and code then
                        ShowCodeWindow(v.Name, code)
                        btn.Text = "✅ Đã mở"
                        btn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
                        wait(2)
                        btn.Text = "  " .. v.Name
                        btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
                    else
                        btn.Text = "❌ Bị khóa"
                        btn.TextColor3 = Color3.new(1,0,0)
                    end
                end)
            end)
        end
    end
    UI.Scroll.CanvasSize = UDim2.new(0, 0, 0, count * 45)
end

-- Tự động quét
task.spawn(function()
    local scripts = {}
    -- Thu thập
    for _, v in pairs(game:GetService("CoreGui"):GetDescendants()) do
        if (v:IsA("LocalScript") or v:IsA("ModuleScript")) and not string.find(v.Name, "Roblox") then
            table.insert(scripts, v)
        end
    end
    for _, v in pairs(game.Players.LocalPlayer:GetDescendants()) do
        if (v:IsA("LocalScript") or v:IsA("ModuleScript")) then
            table.insert(scripts, v)
        end
    end
    
    -- Hiệu ứng chạy thanh Bar
    local total = #scripts
    for i, v in ipairs(scripts) do
        if i % 5 == 0 then task.wait() end -- Chạy mượt
        local p = i / total
        UI.BarFill:TweenSize(UDim2.new(p, 0, 1, 0), "Out", "Quad", 0.05)
        UI.Percent.Text = math.floor(p * 100) .. "%"
        UI.Status.Text = "Đang quét: " .. v.Name
        table.insert(AllScripts, v)
    end
    
    -- Hoàn tất
    UI.Status.Text = "✅ Hoàn tất! Tìm thấy " .. total .. " script."
    UI.Status.TextColor3 = Color3.fromRGB(0, 255, 100)
    wait(1)
    
    -- Hiện danh sách
    UI.Search.Visible = true
    UI.Scroll.Visible = true
    RenderList("")
end)

UI.Search:GetPropertyChangedSignal("Text"):Connect(function()
    RenderList(UI.Search.Text)
end)
