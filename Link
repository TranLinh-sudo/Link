--[[ 
    UNIVERSAL DUMPER - VÉT CẠN TOÀN BỘ
    Chức năng: In tất cả script lạ ra file. Thà giết nhầm hơn bỏ sót!
]]

-- Tạo thư mục riêng để chứa (nếu Executor hỗ trợ)
local FolderName = "TEDDY_DUMP_" .. math.random(1000)
if makefolder then makefolder(FolderName) end

local Count = 0
local TotalSize = 0

game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "ĐANG VÉT CẠN...",
    Text = "Sẽ mất khoảng 1-2 phút. Đừng tắt game!",
    Duration = 10
})

-- Hàm lưu file
local function Save(scriptObj)
    if not decompile then return end
    
    -- Bỏ qua script hệ thống
    if string.find(scriptObj.Name, "Roblox") or string.find(scriptObj:GetFullName(), "CoreScripts") then return end
    
    local success, code = pcall(function() return decompile(scriptObj) end)
    
    if success and #code > 500 then -- Chỉ lấy file > 500 ký tự
        Count = Count + 1
        TotalSize = TotalSize + #code
        
        -- Tạo tên file an toàn
        local cleanName = scriptObj.Name:gsub("[^%w]", "_")
        local path = FolderName .. "/Script_" .. Count .. "_" .. cleanName .. ".txt"
        
        -- Nếu không có makefolder thì lưu thẳng vào workspace với tên tiền tố
        if not makefolder then
            path = "DUMP_" .. Count .. "_" .. cleanName .. ".txt"
        end
        
        writefile(path, "-- Path: " .. scriptObj:GetFullName() .. "\n\n" .. code)
    end
end

task.spawn(function()
    -- 1. Quét CoreGui (Nơi ẩn nấp chính)
    for _, v in pairs(game:GetService("CoreGui"):GetDescendants()) do
        if v:IsA("LocalScript") or v:IsA("ModuleScript") then
            Save(v)
        end
        if Count % 10 == 0 then wait() end -- Nghỉ để đỡ lag
    end
    
    -- 2. Quét Player (Nơi ẩn nấp phụ)
    for _, v in pairs(game.Players.LocalPlayer:GetDescendants()) do
        if v:IsA("LocalScript") or v:IsA("ModuleScript") then
            Save(v)
        end
        if Count % 10 == 0 then wait() end
    end
    
    -- 3. Quét ReplicatedStorage (Nơi chứa Module)
    for _, v in pairs(game:GetService("ReplicatedStorage"):GetDescendants()) do
        if v:IsA("ModuleScript") then
            Save(v)
        end
        if Count % 50 == 0 then wait() end
    end
    
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "HOÀN TẤT!",
        Text = "Đã lưu " .. Count .. " script.\nVào Workspace kiểm tra ngay!",
        Duration = 10
    })
end)
