--[[ 
    THE BLIND SURGEON - PHẪU THUẬT MÙ (QUÉT THEO DỮ LIỆU)
    Chức năng: Không cần tên script. Quét toàn bộ RAM. 
    Hễ thấy dữ liệu liên quan đến Farm là MỔ XẺ ngay.
]]

local FileName = "SURGERY_RESULT.txt"
local HttpService = game:GetService("HttpService")

-- NHỮNG "DẤU HIỆU" ĐỂ NHẬN BIẾT TEDDY HUB (DNA)
-- Chỉ cần hàm nào chứa 1 trong các từ này là bị bắt ngay
local TargetDNA = {
    "CommF_", "StartQuest", "AbandonQuest", "Buso", 
    "BuyItem", "CFrame", "Vector3", "HumanoidRootPart",
    "Mon", "LevelQuest", "NameMon"
}

game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "ĐANG PHẪU THUẬT...",
    Text = "Đang mổ xẻ toàn bộ bộ nhớ... (Sẽ hơi lag)",
    Duration = 10
})

-- Hàm kiểm tra xem hàm này có phải mục tiêu không
local function CheckDNA(constants)
    if not constants then return false end
    local matchCount = 0
    for _, v in pairs(constants) do
        if type(v) == "string" then
            for _, dna in pairs(TargetDNA) do
                if string.find(v, dna) then
                    matchCount = matchCount + 1
                end
            end
        end
    end
    return matchCount >= 2 -- Nếu khớp 2 từ khóa trở lên thì LẤY
end

-- Hàm làm sạch dữ liệu để in
local function Clean(v)
    if typeof(v) == "CFrame" or typeof(v) == "Vector3" then return tostring(v)
    elseif type(v) == "table" then return "Table"
    elseif type(v) == "function" then return "Function"
    else return tostring(v) end
end

task.spawn(function()
    if not getgc or not debug.getconstants or not debug.getupvalues then
        game:GetService("StarterGui"):SetCore("SendNotification", {Title="LỖI", Text="Executor yếu quá!", Duration=5})
        return
    end

    local Output = "=== KẾT QUẢ PHẪU THUẬT (KHÔNG CẦN TÊN) ===\n"
    Output = Output .. "Time: " .. os.date("%X") .. "\n\n"
    
    local Count = 0
    local Scanned = 0
    
    -- 1. QUÉT TOÀN BỘ HÀM TRONG BỘ NHỚ
    for _, v in pairs(getgc()) do
        Scanned = Scanned + 1
        
        -- Chỉ kiểm tra Lua Closure (Hàm do script tạo ra, không phải hàm C++ của game)
        if type(v) == "function" and islclosure(v) and not is_synapse_function(v) then
            
            local constants = debug.getconstants(v)
            
            -- Nếu hàm này có chứa DNA của Teddy Hub
            if CheckDNA(constants) then
                Count = Count + 1
                local info = debug.getinfo(v)
                
                Output = Output .. "------------------------------------------------\n"
                Output = Output .. "[MẪU VẬT #" .. Count .. "] Nguồn: " .. (info.source or "Ẩn danh") .. "\n"
                
                -- PHẪU THUẬT: Lôi hết Hằng số (Constants)
                Output = Output .. ">>> CONSTANTS (Dữ liệu tĩnh):\n"
                for i, k in pairs(constants) do
                    if type(k) == "string" or type(k) == "number" then
                        Output = Output .. "    ["..i.."] " .. tostring(k) .. "\n"
                    end
                end
                
                -- PHẪU THUẬT: Lôi hết Biến ẩn (Upvalues)
                local upvalues = debug.getupvalues(v)
                Output = Output .. ">>> UPVALUES (Dữ liệu động):\n"
                for i, u in pairs(upvalues) do
                    Output = Output .. "    ["..i.."] " .. Clean(u) .. "\n"
                end
                Output = Output .. "\n"
            end
        end
        
        if Scanned % 2000 == 0 then task.wait() end -- Nghỉ để không crash game
    end
    
    -- 2. LƯU KẾT QUẢ
    if Count > 0 then
        writefile(FileName, Output)
        
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "PHẪU THUẬT XONG!",
            Text = "Đã mổ xẻ " .. Count .. " hàm quan trọng.\nFile: " .. FileName,
            Duration = 10
        })
    else
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "THẤT BẠI",
            Text = "Không tìm thấy DNA nào trùng khớp.",
            Duration = 5
        })
    end
end)
